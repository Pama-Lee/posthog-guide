"use strict";(self.webpackChunkposthog_guide=self.webpackChunkposthog_guide||[]).push([[9181],{68619:(n,e,l)=>{l.r(e),l.d(e,{assets:()=>h,contentTitle:()=>c,default:()=>t,frontMatter:()=>d,metadata:()=>i,toc:()=>x});const i=JSON.parse('{"id":"\ud83d\udce1 \u6355\u83b7\u670d\u52a1/architecture","title":"PostHog Capture \u670d\u52a1\u67b6\u6784\u8bbe\u8ba1","description":"1. \u7cfb\u7edf\u6982\u8ff0","source":"@site/docs/\ud83d\udce1 \u6355\u83b7\u670d\u52a1/architecture.md","sourceDirName":"\ud83d\udce1 \u6355\u83b7\u670d\u52a1","slug":"/\ud83d\udce1 \u6355\u83b7\u670d\u52a1/architecture","permalink":"/posthog-guide/docs/\ud83d\udce1 \u6355\u83b7\u670d\u52a1/architecture","draft":false,"unlisted":false,"editUrl":"https://github.com/pama-lee/posthog-guide/tree/main/docs/\ud83d\udce1 \u6355\u83b7\u670d\u52a1/architecture.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"PostHog Capture API \u6587\u6863","permalink":"/posthog-guide/docs/\ud83d\udce1 \u6355\u83b7\u670d\u52a1/api"},"next":{"title":"\ud83e\udd94 Go-Capture \u670d\u52a1\u8be6\u7ec6\u6d41\u7a0b","permalink":"/posthog-guide/docs/\ud83d\udce1 \u6355\u83b7\u670d\u52a1/capture_flow"}}');var s=l(74848),r=l(28453);const d={},c="PostHog Capture \u670d\u52a1\u67b6\u6784\u8bbe\u8ba1",h={},x=[{value:"1. \u7cfb\u7edf\u6982\u8ff0",id:"1-\u7cfb\u7edf\u6982\u8ff0",level:2},{value:"1.1 \u8bbe\u8ba1\u76ee\u6807",id:"11-\u8bbe\u8ba1\u76ee\u6807",level:3},{value:"1.2 \u6280\u672f\u6808\u9009\u62e9",id:"12-\u6280\u672f\u6808\u9009\u62e9",level:3},{value:"2. \u7cfb\u7edf\u67b6\u6784",id:"2-\u7cfb\u7edf\u67b6\u6784",level:2},{value:"2.1 \u6838\u5fc3\u7ec4\u4ef6",id:"21-\u6838\u5fc3\u7ec4\u4ef6",level:3},{value:"2.2 \u7ec4\u4ef6\u804c\u8d23",id:"22-\u7ec4\u4ef6\u804c\u8d23",level:3},{value:"3. \u8be6\u7ec6\u8bbe\u8ba1",id:"3-\u8be6\u7ec6\u8bbe\u8ba1",level:2},{value:"3.1 HTTP \u670d\u52a1\u5c42",id:"31-http-\u670d\u52a1\u5c42",level:3},{value:"3.2 \u4e8b\u4ef6\u5904\u7406\u670d\u52a1",id:"32-\u4e8b\u4ef6\u5904\u7406\u670d\u52a1",level:3},{value:"3.3 \u914d\u989d\u670d\u52a1",id:"33-\u914d\u989d\u670d\u52a1",level:3},{value:"3.4 Kafka \u670d\u52a1",id:"34-kafka-\u670d\u52a1",level:3},{value:"4. \u6570\u636e\u6d41\u8bbe\u8ba1",id:"4-\u6570\u636e\u6d41\u8bbe\u8ba1",level:2},{value:"4.1 \u4e8b\u4ef6\u5904\u7406\u6d41\u7a0b",id:"41-\u4e8b\u4ef6\u5904\u7406\u6d41\u7a0b",level:3},{value:"4.2 \u6570\u636e\u683c\u5f0f",id:"42-\u6570\u636e\u683c\u5f0f",level:3},{value:"5. \u5b58\u50a8\u8bbe\u8ba1",id:"5-\u5b58\u50a8\u8bbe\u8ba1",level:2},{value:"5.1 Kafka \u914d\u7f6e",id:"51-kafka-\u914d\u7f6e",level:3},{value:"5.2 Redis \u8bbe\u8ba1",id:"52-redis-\u8bbe\u8ba1",level:3},{value:"6. \u53ef\u89c2\u6d4b\u6027\u8bbe\u8ba1",id:"6-\u53ef\u89c2\u6d4b\u6027\u8bbe\u8ba1",level:2},{value:"6.1 \u76d1\u63a7\u6307\u6807",id:"61-\u76d1\u63a7\u6307\u6807",level:3},{value:"6.2 \u65e5\u5fd7\u8bbe\u8ba1",id:"62-\u65e5\u5fd7\u8bbe\u8ba1",level:3},{value:"7. \u5b89\u5168\u8bbe\u8ba1",id:"7-\u5b89\u5168\u8bbe\u8ba1",level:2},{value:"7.1 \u8ba4\u8bc1\u673a\u5236",id:"71-\u8ba4\u8bc1\u673a\u5236",level:3},{value:"7.2 \u6570\u636e\u5b89\u5168",id:"72-\u6570\u636e\u5b89\u5168",level:3},{value:"8. \u90e8\u7f72\u67b6\u6784",id:"8-\u90e8\u7f72\u67b6\u6784",level:2},{value:"8.1 \u5bb9\u5668\u5316\u90e8\u7f72",id:"81-\u5bb9\u5668\u5316\u90e8\u7f72",level:3},{value:"8.2 \u9ad8\u53ef\u7528\u8bbe\u8ba1",id:"82-\u9ad8\u53ef\u7528\u8bbe\u8ba1",level:3},{value:"9. \u6269\u5c55\u6027\u8bbe\u8ba1",id:"9-\u6269\u5c55\u6027\u8bbe\u8ba1",level:2},{value:"9.1 \u63d2\u4ef6\u7cfb\u7edf",id:"91-\u63d2\u4ef6\u7cfb\u7edf",level:3},{value:"9.2 \u914d\u7f6e\u7cfb\u7edf",id:"92-\u914d\u7f6e\u7cfb\u7edf",level:3}];function j(n){const e={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.header,{children:(0,s.jsx)(e.h1,{id:"posthog-capture-\u670d\u52a1\u67b6\u6784\u8bbe\u8ba1",children:"PostHog Capture \u670d\u52a1\u67b6\u6784\u8bbe\u8ba1"})}),"\n",(0,s.jsx)(e.h2,{id:"1-\u7cfb\u7edf\u6982\u8ff0",children:"1. \u7cfb\u7edf\u6982\u8ff0"}),"\n",(0,s.jsx)(e.h3,{id:"11-\u8bbe\u8ba1\u76ee\u6807",children:"1.1 \u8bbe\u8ba1\u76ee\u6807"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u9ad8\u6027\u80fd"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u652f\u6301\u9ad8\u5e76\u53d1\u4e8b\u4ef6\u5904\u7406"}),"\n",(0,s.jsx)(e.li,{children:"\u6700\u5c0f\u5316\u5904\u7406\u5ef6\u8fdf"}),"\n",(0,s.jsx)(e.li,{children:"\u4f18\u5316\u8d44\u6e90\u4f7f\u7528"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u9ad8\u53ef\u9760\u6027"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u786e\u4fdd\u4e8b\u4ef6\u4e0d\u4e22\u5931"}),"\n",(0,s.jsx)(e.li,{children:"\u652f\u6301\u6545\u969c\u6062\u590d"}),"\n",(0,s.jsx)(e.li,{children:"\u63d0\u4f9b\u6570\u636e\u4e00\u81f4\u6027"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u53ef\u6269\u5c55\u6027"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u652f\u6301\u6c34\u5e73\u6269\u5c55"}),"\n",(0,s.jsx)(e.li,{children:"\u6a21\u5757\u5316\u8bbe\u8ba1"}),"\n",(0,s.jsx)(e.li,{children:"\u63d2\u4ef6\u5316\u67b6\u6784"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u53ef\u89c2\u6d4b\u6027"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u5168\u9762\u7684\u76d1\u63a7\u6307\u6807"}),"\n",(0,s.jsx)(e.li,{children:"\u8be6\u7ec6\u7684\u65e5\u5fd7\u8bb0\u5f55"}),"\n",(0,s.jsx)(e.li,{children:"\u5206\u5e03\u5f0f\u8ffd\u8e2a\u652f\u6301"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"12-\u6280\u672f\u6808\u9009\u62e9",children:"1.2 \u6280\u672f\u6808\u9009\u62e9"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u6838\u5fc3\u6846\u67b6"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Go 1.21+\uff1a\u6838\u5fc3\u5f00\u53d1\u8bed\u8a00"}),"\n",(0,s.jsx)(e.li,{children:"Gin\uff1aHTTP \u6846\u67b6"}),"\n",(0,s.jsx)(e.li,{children:"Zap\uff1a\u65e5\u5fd7\u6846\u67b6"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u5b58\u50a8\u7cfb\u7edf"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Kafka\uff1a\u4e8b\u4ef6\u5b58\u50a8\u548c\u6d88\u606f\u961f\u5217"}),"\n",(0,s.jsx)(e.li,{children:"Redis\uff1a\u7f13\u5b58\u548c\u901f\u7387\u9650\u5236"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u76d1\u63a7\u5de5\u5177"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Prometheus\uff1a\u6307\u6807\u6536\u96c6"}),"\n",(0,s.jsx)(e.li,{children:"Grafana\uff1a\u53ef\u89c6\u5316\u5c55\u793a"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"2-\u7cfb\u7edf\u67b6\u6784",children:"2. \u7cfb\u7edf\u67b6\u6784"}),"\n",(0,s.jsx)(e.h3,{id:"21-\u6838\u5fc3\u7ec4\u4ef6",children:"2.1 \u6838\u5fc3\u7ec4\u4ef6"}),"\n",(0,s.jsx)(e.mermaid,{value:"graph TD\n    A[HTTP\u670d\u52a1\u5c42] --\x3e B[\u8def\u7531\u5c42]\n    B --\x3e C[\u5904\u7406\u5668\u5c42]\n    C --\x3e D[\u670d\u52a1\u5c42]\n    D --\x3e E[\u5b58\u50a8\u5c42]\n    \n    subgraph \u670d\u52a1\u5c42\n    D1[\u4e8b\u4ef6\u5904\u7406\u670d\u52a1]\n    D2[\u914d\u989d\u670d\u52a1]\n    D3[Kafka\u670d\u52a1]\n    end\n    \n    subgraph \u5b58\u50a8\u5c42\n    E1[Kafka\u96c6\u7fa4]\n    E2[Redis\u96c6\u7fa4]\n    end"}),"\n",(0,s.jsx)(e.h3,{id:"22-\u7ec4\u4ef6\u804c\u8d23",children:"2.2 \u7ec4\u4ef6\u804c\u8d23"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"HTTP \u670d\u52a1\u5c42"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u8bf7\u6c42\u63a5\u6536\u548c\u54cd\u5e94"}),"\n",(0,s.jsx)(e.li,{children:"\u4e2d\u95f4\u4ef6\u5904\u7406"}),"\n",(0,s.jsx)(e.li,{children:"\u9519\u8bef\u5904\u7406"}),"\n",(0,s.jsx)(e.li,{children:"\u8de8\u57df\u652f\u6301"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u8def\u7531\u5c42"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"URL \u8def\u7531\u5339\u914d"}),"\n",(0,s.jsx)(e.li,{children:"\u8bf7\u6c42\u53c2\u6570\u89e3\u6790"}),"\n",(0,s.jsx)(e.li,{children:"\u8ba4\u8bc1\u548c\u6388\u6743"}),"\n",(0,s.jsx)(e.li,{children:"\u8bf7\u6c42\u8f6c\u53d1"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u5904\u7406\u5668\u5c42"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u8bf7\u6c42\u9a8c\u8bc1"}),"\n",(0,s.jsx)(e.li,{children:"\u6570\u636e\u89e3\u6790"}),"\n",(0,s.jsx)(e.li,{children:"\u4e1a\u52a1\u903b\u8f91\u5904\u7406"}),"\n",(0,s.jsx)(e.li,{children:"\u54cd\u5e94\u5c01\u88c5"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u670d\u52a1\u5c42"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u4e8b\u4ef6\u5904\u7406\u670d\u52a1"}),"\n",(0,s.jsx)(e.li,{children:"\u914d\u989d\u63a7\u5236\u670d\u52a1"}),"\n",(0,s.jsx)(e.li,{children:"Kafka \u751f\u4ea7\u670d\u52a1"}),"\n",(0,s.jsx)(e.li,{children:"\u516c\u5171\u670d\u52a1"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u5b58\u50a8\u5c42"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Kafka \u96c6\u7fa4"}),"\n",(0,s.jsx)(e.li,{children:"Redis \u96c6\u7fa4"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"3-\u8be6\u7ec6\u8bbe\u8ba1",children:"3. \u8be6\u7ec6\u8bbe\u8ba1"}),"\n",(0,s.jsx)(e.h3,{id:"31-http-\u670d\u52a1\u5c42",children:"3.1 HTTP \u670d\u52a1\u5c42"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u4e2d\u95f4\u4ef6\u5b9e\u73b0"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:"type Middleware struct {\n    // \u4e2d\u95f4\u4ef6\u914d\u7f6e\n    Config *Config\n    // \u4e2d\u95f4\u4ef6\u94fe\n    handlers []gin.HandlerFunc\n}\n"})}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u5173\u952e\u4e2d\u95f4\u4ef6"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"CORS \u4e2d\u95f4\u4ef6"}),"\n",(0,s.jsx)(e.li,{children:"\u8ba4\u8bc1\u4e2d\u95f4\u4ef6"}),"\n",(0,s.jsx)(e.li,{children:"\u65e5\u5fd7\u4e2d\u95f4\u4ef6"}),"\n",(0,s.jsx)(e.li,{children:"\u6307\u6807\u4e2d\u95f4\u4ef6"}),"\n",(0,s.jsx)(e.li,{children:"\u6062\u590d\u4e2d\u95f4\u4ef6"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"32-\u4e8b\u4ef6\u5904\u7406\u670d\u52a1",children:"3.2 \u4e8b\u4ef6\u5904\u7406\u670d\u52a1"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u63a5\u53e3\u5b9a\u4e49"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:"type EventProcessor interface {\n    ProcessEvent(ctx context.Context, event Event, token string) error\n    ProcessRecording(ctx context.Context, event Event, token string) error\n}\n"})}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u6838\u5fc3\u529f\u80fd"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u4e8b\u4ef6\u9a8c\u8bc1"}),"\n",(0,s.jsx)(e.li,{children:"\u53bb\u91cd\u5904\u7406"}),"\n",(0,s.jsx)(e.li,{children:"\u914d\u989d\u63a7\u5236"}),"\n",(0,s.jsx)(e.li,{children:"\u6279\u5904\u7406\u673a\u5236"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u5b9e\u73b0\u7ec6\u8282"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u5f02\u6b65\u5904\u7406"}),"\n",(0,s.jsx)(e.li,{children:"\u91cd\u8bd5\u673a\u5236"}),"\n",(0,s.jsx)(e.li,{children:"\u9519\u8bef\u5904\u7406"}),"\n",(0,s.jsx)(e.li,{children:"\u6027\u80fd\u4f18\u5316"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"33-\u914d\u989d\u670d\u52a1",children:"3.3 \u914d\u989d\u670d\u52a1"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u63a5\u53e3\u5b9a\u4e49"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:"type QuotaService interface {\n    CheckQuota(ctx context.Context, token string, eventType string) (bool, error)\n    DecrementQuota(ctx context.Context, token string, eventType string) error\n}\n"})}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u5b9e\u73b0\u7279\u6027"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Redis \u8ba1\u6570\u5668"}),"\n",(0,s.jsx)(e.li,{children:"\u8fc7\u671f\u65f6\u95f4\u63a7\u5236"}),"\n",(0,s.jsx)(e.li,{children:"\u539f\u5b50\u64cd\u4f5c"}),"\n",(0,s.jsx)(e.li,{children:"\u914d\u989d\u6062\u590d"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"34-kafka-\u670d\u52a1",children:"3.4 Kafka \u670d\u52a1"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u63a5\u53e3\u5b9a\u4e49"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:"type KafkaService interface {\n    SendEvent(topic string, data []byte, headers map[string]string, key *string) error\n    GetEventsTopic() string\n    GetRecordingsTopic() string\n}\n"})}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u5b9e\u73b0\u7279\u6027"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u5f02\u6b65\u53d1\u9001"}),"\n",(0,s.jsx)(e.li,{children:"\u6279\u91cf\u63d0\u4ea4"}),"\n",(0,s.jsx)(e.li,{children:"\u538b\u7f29\u652f\u6301"}),"\n",(0,s.jsx)(e.li,{children:"\u5206\u533a\u7b56\u7565"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"4-\u6570\u636e\u6d41\u8bbe\u8ba1",children:"4. \u6570\u636e\u6d41\u8bbe\u8ba1"}),"\n",(0,s.jsx)(e.h3,{id:"41-\u4e8b\u4ef6\u5904\u7406\u6d41\u7a0b",children:"4.1 \u4e8b\u4ef6\u5904\u7406\u6d41\u7a0b"}),"\n",(0,s.jsx)(e.mermaid,{value:"sequenceDiagram\n    participant C as \u5ba2\u6237\u7aef\n    participant H as HTTP\u670d\u52a1\n    participant P as \u5904\u7406\u5668\n    participant E as \u4e8b\u4ef6\u670d\u52a1\n    participant K as Kafka\u670d\u52a1\n    participant R as Redis\u670d\u52a1\n\n    C->>H: \u53d1\u9001\u4e8b\u4ef6\n    H->>P: \u8def\u7531\u5206\u53d1\n    P->>E: \u5904\u7406\u4e8b\u4ef6\n    E->>R: \u68c0\u67e5\u914d\u989d\n    E->>R: \u68c0\u67e5\u53bb\u91cd\n    E->>K: \u53d1\u9001\u6d88\u606f\n    K->>E: \u786e\u8ba4\u53d1\u9001\n    E->>P: \u8fd4\u56de\u7ed3\u679c\n    P->>H: \u54cd\u5e94\u5ba2\u6237\u7aef\n    H->>C: \u8fd4\u56de\u7ed3\u679c"}),"\n",(0,s.jsx)(e.h3,{id:"42-\u6570\u636e\u683c\u5f0f",children:"4.2 \u6570\u636e\u683c\u5f0f"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u8f93\u5165\u683c\u5f0f"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",children:'{\n    "event": "\u4e8b\u4ef6\u540d\u79f0",\n    "properties": {\n        "distinct_id": "\u7528\u6237\u6807\u8bc6",\n        "token": "\u9879\u76ee\u4ee4\u724c"\n    },\n    "timestamp": "\u65f6\u95f4\u6233"\n}\n'})}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Kafka \u6d88\u606f\u683c\u5f0f"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",children:'{\n    "uuid": "\u4e8b\u4ef6ID",\n    "distinct_id": "\u7528\u6237\u6807\u8bc6",\n    "data": "\u4e8b\u4ef6\u6570\u636e",\n    "timestamp": "\u5904\u7406\u65f6\u95f4"\n}\n'})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"5-\u5b58\u50a8\u8bbe\u8ba1",children:"5. \u5b58\u50a8\u8bbe\u8ba1"}),"\n",(0,s.jsx)(e.h3,{id:"51-kafka-\u914d\u7f6e",children:"5.1 Kafka \u914d\u7f6e"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u4e3b\u9898\u8bbe\u8ba1"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"clickhouse_events"}),": \u666e\u901a\u4e8b\u4ef6"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"clickhouse_session_recording_events"}),": \u5f55\u5236\u4e8b\u4ef6"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"historical_events"}),": \u5386\u53f2\u4e8b\u4ef6"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"client_warnings"}),": \u5ba2\u6237\u7aef\u8b66\u544a"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"exceptions"}),": \u5f02\u5e38\u4e8b\u4ef6"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u5206\u533a\u7b56\u7565"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u57fa\u4e8e token \u548c distinct_id \u7684\u81ea\u5b9a\u4e49\u5206\u533a"}),"\n",(0,s.jsx)(e.li,{children:"\u786e\u4fdd\u540c\u7528\u6237\u4e8b\u4ef6\u987a\u5e8f"}),"\n",(0,s.jsx)(e.li,{children:"\u652f\u6301\u6c34\u5e73\u6269\u5c55"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"52-redis-\u8bbe\u8ba1",children:"5.2 Redis \u8bbe\u8ba1"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u952e\u8bbe\u8ba1"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\u914d\u989d\u952e\uff1a",(0,s.jsx)(e.code,{children:"quota:{token}:{event_type}"})]}),"\n",(0,s.jsxs)(e.li,{children:["\u53bb\u91cd\u952e\uff1a",(0,s.jsx)(e.code,{children:"event:{distinct_id}:{event}:{timestamp}"})]}),"\n",(0,s.jsxs)(e.li,{children:["\u901f\u7387\u952e\uff1a",(0,s.jsx)(e.code,{children:"rate:{token}:{event_type}"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u6570\u636e\u7ed3\u6784"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"String\uff1a\u914d\u989d\u8ba1\u6570"}),"\n",(0,s.jsx)(e.li,{children:"Hash\uff1a\u7528\u6237\u914d\u7f6e"}),"\n",(0,s.jsx)(e.li,{children:"Set\uff1a\u53bb\u91cd\u96c6\u5408"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"6-\u53ef\u89c2\u6d4b\u6027\u8bbe\u8ba1",children:"6. \u53ef\u89c2\u6d4b\u6027\u8bbe\u8ba1"}),"\n",(0,s.jsx)(e.h3,{id:"61-\u76d1\u63a7\u6307\u6807",children:"6.1 \u76d1\u63a7\u6307\u6807"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u4e1a\u52a1\u6307\u6807"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u4e8b\u4ef6\u63a5\u6536\u901f\u7387"}),"\n",(0,s.jsx)(e.li,{children:"\u5904\u7406\u5ef6\u8fdf"}),"\n",(0,s.jsx)(e.li,{children:"\u9519\u8bef\u7387"}),"\n",(0,s.jsx)(e.li,{children:"\u914d\u989d\u4f7f\u7528\u7387"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u7cfb\u7edf\u6307\u6807"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"CPU \u4f7f\u7528\u7387"}),"\n",(0,s.jsx)(e.li,{children:"\u5185\u5b58\u4f7f\u7528\u7387"}),"\n",(0,s.jsx)(e.li,{children:"Goroutine \u6570\u91cf"}),"\n",(0,s.jsx)(e.li,{children:"GC \u7edf\u8ba1"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"62-\u65e5\u5fd7\u8bbe\u8ba1",children:"6.2 \u65e5\u5fd7\u8bbe\u8ba1"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u65e5\u5fd7\u7ea7\u522b"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"DEBUG\uff1a\u8c03\u8bd5\u4fe1\u606f"}),"\n",(0,s.jsx)(e.li,{children:"INFO\uff1a\u5173\u952e\u64cd\u4f5c"}),"\n",(0,s.jsx)(e.li,{children:"WARN\uff1a\u8b66\u544a\u4fe1\u606f"}),"\n",(0,s.jsx)(e.li,{children:"ERROR\uff1a\u9519\u8bef\u4fe1\u606f"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u65e5\u5fd7\u683c\u5f0f"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-json",children:'{\n    "level": "\u65e5\u5fd7\u7ea7\u522b",\n    "timestamp": "\u65f6\u95f4\u6233",\n    "caller": "\u8c03\u7528\u4f4d\u7f6e",\n    "msg": "\u65e5\u5fd7\u6d88\u606f",\n    "fields": {\n        "event_id": "\u4e8b\u4ef6ID",\n        "token": "\u9879\u76ee\u4ee4\u724c"\n    }\n}\n'})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"7-\u5b89\u5168\u8bbe\u8ba1",children:"7. \u5b89\u5168\u8bbe\u8ba1"}),"\n",(0,s.jsx)(e.h3,{id:"71-\u8ba4\u8bc1\u673a\u5236",children:"7.1 \u8ba4\u8bc1\u673a\u5236"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Token \u9a8c\u8bc1"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u8bf7\u6c42\u5934\u9a8c\u8bc1"}),"\n",(0,s.jsx)(e.li,{children:"\u53c2\u6570\u9a8c\u8bc1"}),"\n",(0,s.jsx)(e.li,{children:"\u591a\u7ea7\u9a8c\u8bc1"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u6743\u9650\u63a7\u5236"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u9879\u76ee\u7ea7\u522b\u6743\u9650"}),"\n",(0,s.jsx)(e.li,{children:"\u63a5\u53e3\u7ea7\u522b\u6743\u9650"}),"\n",(0,s.jsx)(e.li,{children:"\u8d44\u6e90\u7ea7\u522b\u6743\u9650"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"72-\u6570\u636e\u5b89\u5168",children:"7.2 \u6570\u636e\u5b89\u5168"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u4f20\u8f93\u5b89\u5168"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"TLS \u52a0\u5bc6"}),"\n",(0,s.jsx)(e.li,{children:"\u6570\u636e\u538b\u7f29"}),"\n",(0,s.jsx)(e.li,{children:"\u8bf7\u6c42\u7b7e\u540d"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u5b58\u50a8\u5b89\u5168"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u6570\u636e\u8131\u654f"}),"\n",(0,s.jsx)(e.li,{children:"\u8bbf\u95ee\u63a7\u5236"}),"\n",(0,s.jsx)(e.li,{children:"\u5ba1\u8ba1\u65e5\u5fd7"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"8-\u90e8\u7f72\u67b6\u6784",children:"8. \u90e8\u7f72\u67b6\u6784"}),"\n",(0,s.jsx)(e.h3,{id:"81-\u5bb9\u5668\u5316\u90e8\u7f72",children:"8.1 \u5bb9\u5668\u5316\u90e8\u7f72"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Docker \u914d\u7f6e"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-dockerfile",children:'FROM golang:1.21-alpine\nWORKDIR /app\nCOPY . .\nRUN go build -o capture\nCMD ["./capture"]\n'})}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u8d44\u6e90\u914d\u7f6e"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"CPU \u9650\u5236"}),"\n",(0,s.jsx)(e.li,{children:"\u5185\u5b58\u9650\u5236"}),"\n",(0,s.jsx)(e.li,{children:"\u5b58\u50a8\u914d\u7f6e"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"82-\u9ad8\u53ef\u7528\u8bbe\u8ba1",children:"8.2 \u9ad8\u53ef\u7528\u8bbe\u8ba1"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u591a\u5b9e\u4f8b\u90e8\u7f72"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u8d1f\u8f7d\u5747\u8861"}),"\n",(0,s.jsx)(e.li,{children:"\u81ea\u52a8\u6269\u7f29\u5bb9"}),"\n",(0,s.jsx)(e.li,{children:"\u5065\u5eb7\u68c0\u67e5"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u6545\u969c\u8f6c\u79fb"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u670d\u52a1\u53d1\u73b0"}),"\n",(0,s.jsx)(e.li,{children:"\u81ea\u52a8\u6062\u590d"}),"\n",(0,s.jsx)(e.li,{children:"\u6570\u636e\u540c\u6b65"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"9-\u6269\u5c55\u6027\u8bbe\u8ba1",children:"9. \u6269\u5c55\u6027\u8bbe\u8ba1"}),"\n",(0,s.jsx)(e.h3,{id:"91-\u63d2\u4ef6\u7cfb\u7edf",children:"9.1 \u63d2\u4ef6\u7cfb\u7edf"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u63d2\u4ef6\u63a5\u53e3"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:"type Plugin interface {\n    Init() error\n    Process(event Event) error\n    Close() error\n}\n"})}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u652f\u6301\u7c7b\u578b"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u6570\u636e\u5904\u7406\u63d2\u4ef6"}),"\n",(0,s.jsx)(e.li,{children:"\u8ba4\u8bc1\u63d2\u4ef6"}),"\n",(0,s.jsx)(e.li,{children:"\u5b58\u50a8\u63d2\u4ef6"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"92-\u914d\u7f6e\u7cfb\u7edf",children:"9.2 \u914d\u7f6e\u7cfb\u7edf"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u914d\u7f6e\u7ed3\u6784"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:"type Config struct {\n    Server   ServerConfig\n    Kafka    KafkaConfig\n    Redis    RedisConfig\n    Plugins  PluginConfig\n}\n"})}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u52a8\u6001\u914d\u7f6e"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u914d\u7f6e\u70ed\u52a0\u8f7d"}),"\n",(0,s.jsx)(e.li,{children:"\u73af\u5883\u53d8\u91cf\u652f\u6301"}),"\n",(0,s.jsx)(e.li,{children:"\u914d\u7f6e\u9a8c\u8bc1"}),"\n"]}),"\n"]}),"\n"]})]})}function t(n={}){const{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(j,{...n})}):j(n)}},28453:(n,e,l)=>{l.d(e,{R:()=>d,x:()=>c});var i=l(96540);const s={},r=i.createContext(s);function d(n){const e=i.useContext(r);return i.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:d(n.components),i.createElement(r.Provider,{value:e},n.children)}}}]);