"use strict";(self.webpackChunkposthog_guide=self.webpackChunkposthog_guide||[]).push([[5301],{7215:(n,e,i)=>{i.r(e),i.d(e,{assets:()=>c,contentTitle:()=>t,default:()=>o,frontMatter:()=>d,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"\ud83e\udde9 \u63d2\u4ef6\u4e0e\u8d44\u6e90/plugins","title":"\ud83d\udd0c PostHog \u63d2\u4ef6\u7cfb\u7edf","description":"\u6982\u8ff0","source":"@site/docs/\ud83e\udde9 \u63d2\u4ef6\u4e0e\u8d44\u6e90/plugins.mdx","sourceDirName":"\ud83e\udde9 \u63d2\u4ef6\u4e0e\u8d44\u6e90","slug":"/\ud83e\udde9 \u63d2\u4ef6\u4e0e\u8d44\u6e90/plugins","permalink":"/posthog-guide/docs/\ud83e\udde9 \u63d2\u4ef6\u4e0e\u8d44\u6e90/plugins","draft":false,"unlisted":false,"editUrl":"https://github.com/pama-lee/posthog-guide/tree/main/docs/\ud83e\udde9 \u63d2\u4ef6\u4e0e\u8d44\u6e90/plugins.mdx","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"\ud83d\udecd\ufe0f PostHog \u63d2\u4ef6\u5e02\u573a","permalink":"/posthog-guide/docs/\ud83e\udde9 \u63d2\u4ef6\u4e0e\u8d44\u6e90/plugin-market"}}');var l=i(74848),r=i(28453);const d={},t="\ud83d\udd0c PostHog \u63d2\u4ef6\u7cfb\u7edf",c={},a=[{value:"\u6982\u8ff0",id:"\u6982\u8ff0",level:2},{value:"\u63d2\u4ef6\u7c7b\u578b",id:"\u63d2\u4ef6\u7c7b\u578b",level:2},{value:"\u63d2\u4ef6\u914d\u7f6e",id:"\u63d2\u4ef6\u914d\u7f6e",level:2},{value:"plugin.json",id:"pluginjson",level:3},{value:"\u914d\u7f6e\u9879\u7c7b\u578b",id:"\u914d\u7f6e\u9879\u7c7b\u578b",level:3},{value:"\u63d2\u4ef6\u529f\u80fd",id:"\u63d2\u4ef6\u529f\u80fd",level:2},{value:"\u4e8b\u4ef6\u5904\u7406",id:"\u4e8b\u4ef6\u5904\u7406",level:3},{value:"\u5b9a\u65f6\u4efb\u52a1",id:"\u5b9a\u65f6\u4efb\u52a1",level:3},{value:"\u63d2\u4ef6\u80fd\u529b",id:"\u63d2\u4ef6\u80fd\u529b",level:3},{value:"\u63d2\u4ef6\u751f\u547d\u5468\u671f",id:"\u63d2\u4ef6\u751f\u547d\u5468\u671f",level:2},{value:"\u63d2\u4ef6\u5f00\u53d1\u6307\u5357",id:"\u63d2\u4ef6\u5f00\u53d1\u6307\u5357",level:2},{value:"\u76ee\u5f55\u7ed3\u6784",id:"\u76ee\u5f55\u7ed3\u6784",level:3},{value:"\u5f00\u53d1\u6d41\u7a0b",id:"\u5f00\u53d1\u6d41\u7a0b",level:3},{value:"\u6700\u4f73\u5b9e\u8df5",id:"\u6700\u4f73\u5b9e\u8df5",level:3},{value:"\u63d2\u4ef6\u5b89\u5168",id:"\u63d2\u4ef6\u5b89\u5168",level:2},{value:"\u6743\u9650\u7ea7\u522b",id:"\u6743\u9650\u7ea7\u522b",level:3},{value:"\u5b89\u5168\u5efa\u8bae",id:"\u5b89\u5168\u5efa\u8bae",level:3},{value:"\u76d1\u63a7\u548c\u8c03\u8bd5",id:"\u76d1\u63a7\u548c\u8c03\u8bd5",level:2},{value:"\u65e5\u5fd7\u7ea7\u522b",id:"\u65e5\u5fd7\u7ea7\u522b",level:3},{value:"\u6027\u80fd\u6307\u6807",id:"\u6027\u80fd\u6307\u6807",level:3},{value:"\u5e38\u89c1\u95ee\u9898",id:"\u5e38\u89c1\u95ee\u9898",level:2},{value:"1. \u63d2\u4ef6\u52a0\u8f7d\u5931\u8d25",id:"1-\u63d2\u4ef6\u52a0\u8f7d\u5931\u8d25",level:3},{value:"2. \u6027\u80fd\u95ee\u9898",id:"2-\u6027\u80fd\u95ee\u9898",level:3},{value:"3. \u7248\u672c\u517c\u5bb9",id:"3-\u7248\u672c\u517c\u5bb9",level:3},{value:"API \u53c2\u8003",id:"api-\u53c2\u8003",level:2},{value:"\u4e8b\u4ef6\u5bf9\u8c61",id:"\u4e8b\u4ef6\u5bf9\u8c61",level:3},{value:"Webhook \u5bf9\u8c61",id:"webhook-\u5bf9\u8c61",level:3},{value:"\u914d\u7f6e\u6a21\u5f0f",id:"\u914d\u7f6e\u6a21\u5f0f",level:3},{value:"\u793a\u4f8b\u63d2\u4ef6",id:"\u793a\u4f8b\u63d2\u4ef6",level:2},{value:"\u57fa\u7840\u63d2\u4ef6\u6a21\u677f",id:"\u57fa\u7840\u63d2\u4ef6\u6a21\u677f",level:3},{value:"\u5b9a\u65f6\u4efb\u52a1\u793a\u4f8b",id:"\u5b9a\u65f6\u4efb\u52a1\u793a\u4f8b",level:3},{value:"\u66f4\u591a\u8d44\u6e90",id:"\u66f4\u591a\u8d44\u6e90",level:2},{value:"\u6280\u672f\u5b9e\u73b0",id:"\u6280\u672f\u5b9e\u73b0",level:2},{value:"\u63d2\u4ef6\u52a0\u8f7d\u6d41\u7a0b",id:"\u63d2\u4ef6\u52a0\u8f7d\u6d41\u7a0b",level:3},{value:"\u865a\u62df\u673a\u5b9e\u73b0",id:"\u865a\u62df\u673a\u5b9e\u73b0",level:3},{value:"\u63d2\u4ef6\u80fd\u529b\u68c0\u6d4b",id:"\u63d2\u4ef6\u80fd\u529b\u68c0\u6d4b",level:3},{value:"\u9519\u8bef\u5904\u7406",id:"\u9519\u8bef\u5904\u7406",level:3},{value:"\u6027\u80fd\u76d1\u63a7",id:"\u6027\u80fd\u76d1\u63a7",level:3},{value:"\u65e5\u5fd7\u7cfb\u7edf",id:"\u65e5\u5fd7\u7cfb\u7edf",level:3},{value:"\u5b89\u5168\u9650\u5236",id:"\u5b89\u5168\u9650\u5236",level:3},{value:"\u63d2\u4ef6\u901a\u4fe1",id:"\u63d2\u4ef6\u901a\u4fe1",level:3},{value:"\u4e8b\u4ef6\u5904\u7406\u8be6\u89e3",id:"\u4e8b\u4ef6\u5904\u7406\u8be6\u89e3",level:2},{value:"\u4e8b\u4ef6\u7c7b\u578b",id:"\u4e8b\u4ef6\u7c7b\u578b",level:3},{value:"\u4e8b\u4ef6\u5904\u7406\u6d41\u7a0b",id:"\u4e8b\u4ef6\u5904\u7406\u6d41\u7a0b",level:3},{value:"\u7279\u6b8a\u4e8b\u4ef6",id:"\u7279\u6b8a\u4e8b\u4ef6",level:3},{value:"\u4e8b\u4ef6\u5c5e\u6027\u5904\u7406",id:"\u4e8b\u4ef6\u5c5e\u6027\u5904\u7406",level:3},{value:"\u4e8b\u4ef6\u5904\u7406\u80fd\u529b",id:"\u4e8b\u4ef6\u5904\u7406\u80fd\u529b",level:3},{value:"\u4e8b\u4ef6\u5904\u7406\u6307\u6807",id:"\u4e8b\u4ef6\u5904\u7406\u6307\u6807",level:3},{value:"\u4e8b\u4ef6\u5904\u7406\u6700\u4f73\u5b9e\u8df5",id:"\u4e8b\u4ef6\u5904\u7406\u6700\u4f73\u5b9e\u8df5",level:3},{value:"\u63d2\u4ef6\u670d\u52a1\u5668\u5b9e\u73b0",id:"\u63d2\u4ef6\u670d\u52a1\u5668\u5b9e\u73b0",level:2},{value:"\u670d\u52a1\u5668\u67b6\u6784",id:"\u670d\u52a1\u5668\u67b6\u6784",level:3},{value:"\u670d\u52a1\u5668\u6a21\u5f0f",id:"\u670d\u52a1\u5668\u6a21\u5f0f",level:3},{value:"\u63d2\u4ef6\u52a0\u8f7d\u6d41\u7a0b",id:"\u63d2\u4ef6\u52a0\u8f7d\u6d41\u7a0b-1",level:3},{value:"\u63d2\u4ef6\u6267\u884c\u73af\u5883",id:"\u63d2\u4ef6\u6267\u884c\u73af\u5883",level:3},{value:"\u63d2\u4ef6\u901a\u4fe1\u673a\u5236",id:"\u63d2\u4ef6\u901a\u4fe1\u673a\u5236",level:3},{value:"\u9519\u8bef\u5904\u7406\u673a\u5236",id:"\u9519\u8bef\u5904\u7406\u673a\u5236",level:3},{value:"\u6027\u80fd\u4f18\u5316",id:"\u6027\u80fd\u4f18\u5316",level:3}];function h(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...n.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(e.header,{children:(0,l.jsx)(e.h1,{id:"-posthog-\u63d2\u4ef6\u7cfb\u7edf",children:"\ud83d\udd0c PostHog \u63d2\u4ef6\u7cfb\u7edf"})}),"\n",(0,l.jsx)(e.h2,{id:"\u6982\u8ff0",children:"\u6982\u8ff0"}),"\n",(0,l.jsx)(e.p,{children:"PostHog \u63d2\u4ef6\u7cfb\u7edf\u662f\u4e00\u4e2a\u5f3a\u5927\u800c\u7075\u6d3b\u7684\u6269\u5c55\u673a\u5236\uff0c\u8ba9\u5f00\u53d1\u8005\u80fd\u591f\u901a\u8fc7\u63d2\u4ef6\u6765\u6269\u5c55\u548c\u81ea\u5b9a\u4e49 PostHog \u7684\u529f\u80fd\u3002\u63d2\u4ef6\u53ef\u4ee5:"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5904\u7406\u4e8b\u4ef6\u6d41"}),"\n",(0,l.jsx)(e.li,{children:"\u6267\u884c\u5b9a\u65f6\u4efb\u52a1"}),"\n",(0,l.jsx)(e.li,{children:"\u96c6\u6210\u5916\u90e8\u7cfb\u7edf"}),"\n",(0,l.jsx)(e.li,{children:"\u81ea\u5b9a\u4e49\u6570\u636e\u5904\u7406"}),"\n",(0,l.jsx)(e.li,{children:"\u6269\u5c55\u7528\u6237\u754c\u9762"}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"\u63d2\u4ef6\u7c7b\u578b",children:"\u63d2\u4ef6\u7c7b\u578b"}),"\n",(0,l.jsx)(e.p,{children:"PostHog \u652f\u6301\u4ee5\u4e0b\u51e0\u79cd\u7c7b\u578b\u7684\u63d2\u4ef6:"}),"\n",(0,l.jsxs)(e.table,{children:[(0,l.jsx)(e.thead,{children:(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.th,{children:"\u7c7b\u578b"}),(0,l.jsx)(e.th,{children:"\u63cf\u8ff0"}),(0,l.jsx)(e.th,{children:"\u4f7f\u7528\u573a\u666f"})]})}),(0,l.jsxs)(e.tbody,{children:[(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:(0,l.jsx)(e.code,{children:"local"})}),(0,l.jsx)(e.td,{children:"\u672c\u5730\u5f00\u53d1\u7684\u63d2\u4ef6"}),(0,l.jsx)(e.td,{children:"\u5f00\u53d1\u548c\u6d4b\u8bd5\u9636\u6bb5"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:(0,l.jsx)(e.code,{children:"repository"})}),(0,l.jsx)(e.td,{children:"\u4ece\u4ee3\u7801\u4ed3\u5e93\u5b89\u88c5\u7684\u63d2\u4ef6"}),(0,l.jsx)(e.td,{children:"\u751f\u4ea7\u73af\u5883\u90e8\u7f72"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:(0,l.jsx)(e.code,{children:"custom"})}),(0,l.jsx)(e.td,{children:"\u81ea\u5b9a\u4e49\u63d2\u4ef6"}),(0,l.jsx)(e.td,{children:"\u7279\u5b9a\u9700\u6c42\u5b9a\u5236"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:(0,l.jsx)(e.code,{children:"source"})}),(0,l.jsx)(e.td,{children:"\u6e90\u4ee3\u7801\u5f62\u5f0f\u7684\u63d2\u4ef6"}),(0,l.jsx)(e.td,{children:"\u4e8c\u6b21\u5f00\u53d1"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:(0,l.jsx)(e.code,{children:"inline"})}),(0,l.jsx)(e.td,{children:"\u5185\u8054\u63d2\u4ef6"}),(0,l.jsx)(e.td,{children:"\u7b80\u5355\u529f\u80fd\u6269\u5c55"})]})]})]}),"\n",(0,l.jsx)(e.h2,{id:"\u63d2\u4ef6\u914d\u7f6e",children:"\u63d2\u4ef6\u914d\u7f6e"}),"\n",(0,l.jsx)(e.h3,{id:"pluginjson",children:"plugin.json"}),"\n",(0,l.jsxs)(e.p,{children:["\u6bcf\u4e2a\u63d2\u4ef6\u90fd\u9700\u8981\u4e00\u4e2a ",(0,l.jsx)(e.code,{children:"plugin.json"})," \u914d\u7f6e\u6587\u4ef6:"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-json",children:'{\n  "name": "\u63d2\u4ef6\u540d\u79f0",\n  "description": "\u63d2\u4ef6\u63cf\u8ff0",\n  "url": "\u63d2\u4ef6\u4e3b\u9875",\n  "main": "\u5165\u53e3\u6587\u4ef6",\n  "lib": "\u5e93\u6587\u4ef6",\n  "config": {\n    // \u63d2\u4ef6\u914d\u7f6e\u9879\u5b9a\u4e49\n  }\n}\n'})}),"\n",(0,l.jsx)(e.h3,{id:"\u914d\u7f6e\u9879\u7c7b\u578b",children:"\u914d\u7f6e\u9879\u7c7b\u578b"}),"\n",(0,l.jsxs)(e.table,{children:[(0,l.jsx)(e.thead,{children:(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.th,{children:"\u7c7b\u578b"}),(0,l.jsx)(e.th,{children:"\u8bf4\u660e"}),(0,l.jsx)(e.th,{children:"\u793a\u4f8b"})]})}),(0,l.jsxs)(e.tbody,{children:[(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:(0,l.jsx)(e.code,{children:"string"})}),(0,l.jsx)(e.td,{children:"\u5b57\u7b26\u4e32"}),(0,l.jsx)(e.td,{children:"\u7528\u6237\u540d\u3001URL"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:(0,l.jsx)(e.code,{children:"boolean"})}),(0,l.jsx)(e.td,{children:"\u5e03\u5c14\u503c"}),(0,l.jsx)(e.td,{children:"\u5f00\u5173\u6807\u5fd7"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:(0,l.jsx)(e.code,{children:"json"})}),(0,l.jsx)(e.td,{children:"JSON\u5bf9\u8c61"}),(0,l.jsx)(e.td,{children:"\u590d\u6742\u914d\u7f6e"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:(0,l.jsx)(e.code,{children:"number"})}),(0,l.jsx)(e.td,{children:"\u6570\u5b57"}),(0,l.jsx)(e.td,{children:"\u9608\u503c\u3001\u6570\u91cf"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:(0,l.jsx)(e.code,{children:"date"})}),(0,l.jsx)(e.td,{children:"\u65e5\u671f"}),(0,l.jsx)(e.td,{children:"\u5f00\u59cb\u65f6\u95f4"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:(0,l.jsx)(e.code,{children:"daterange"})}),(0,l.jsx)(e.td,{children:"\u65e5\u671f\u8303\u56f4"}),(0,l.jsx)(e.td,{children:"\u7edf\u8ba1\u5468\u671f"})]})]})]}),"\n",(0,l.jsx)(e.h2,{id:"\u63d2\u4ef6\u529f\u80fd",children:"\u63d2\u4ef6\u529f\u80fd"}),"\n",(0,l.jsx)(e.h3,{id:"\u4e8b\u4ef6\u5904\u7406",children:"\u4e8b\u4ef6\u5904\u7406"}),"\n",(0,l.jsx)(e.p,{children:"\u63d2\u4ef6\u53ef\u4ee5\u901a\u8fc7\u5b9e\u73b0\u4ee5\u4e0b\u65b9\u6cd5\u6765\u5904\u7406\u4e8b\u4ef6:"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"interface PluginMethods {\n  // \u63d2\u4ef6\u521d\u59cb\u5316\n  setupPlugin?: () => Promise<void>\n  \n  // \u63d2\u4ef6\u6e05\u7406\n  teardownPlugin?: () => Promise<void>\n  \n  // \u83b7\u53d6\u63d2\u4ef6\u8bbe\u7f6e\n  getSettings?: () => PluginSettings\n  \n  // \u5904\u7406\u4e8b\u4ef6\n  onEvent?: (event: ProcessedPluginEvent) => Promise<void>\n  \n  // \u7ec4\u88c5 Webhook\n  composeWebhook?: (event: PostHogEvent) => Webhook | null\n  \n  // \u5904\u7406\u4e8b\u4ef6\n  processEvent?: (event: PluginEvent) => Promise<PluginEvent>\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u5b9a\u65f6\u4efb\u52a1",children:"\u5b9a\u65f6\u4efb\u52a1"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"interface PluginTask {\n  name: string\n  type: 'job' | 'schedule'\n  exec: (payload?: Record<string, any>) => Promise<any>\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u63d2\u4ef6\u80fd\u529b",children:"\u63d2\u4ef6\u80fd\u529b"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"interface PluginCapabilities {\n  jobs?: string[]  // \u652f\u6301\u7684\u4efb\u52a1\n  scheduled_tasks?: string[] // \u652f\u6301\u7684\u5b9a\u65f6\u4efb\u52a1\n  methods?: string[] // \u652f\u6301\u7684\u65b9\u6cd5\n}\n"})}),"\n",(0,l.jsx)(e.h2,{id:"\u63d2\u4ef6\u751f\u547d\u5468\u671f",children:"\u63d2\u4ef6\u751f\u547d\u5468\u671f"}),"\n",(0,l.jsx)(e.mermaid,{value:"graph TD\n    A[\u52a0\u8f7d\u9636\u6bb5] --\x3e B[\u8fd0\u884c\u9636\u6bb5]\n    B --\x3e C[\u5378\u8f7d\u9636\u6bb5]\n    A --\x3e D[\u8bfb\u53d6\u914d\u7f6e]\n    A --\x3e E[\u521d\u59cb\u5316\u5b9e\u4f8b]\n    A --\x3e F[\u8c03\u7528 setupPlugin]\n    B --\x3e G[\u5904\u7406\u4e8b\u4ef6]\n    B --\x3e H[\u6267\u884c\u4efb\u52a1]\n    B --\x3e I[\u8c03\u7528\u65b9\u6cd5]\n    C --\x3e J[\u8c03\u7528 teardownPlugin]\n    C --\x3e K[\u6e05\u7406\u8d44\u6e90]"}),"\n",(0,l.jsx)(e.h2,{id:"\u63d2\u4ef6\u5f00\u53d1\u6307\u5357",children:"\u63d2\u4ef6\u5f00\u53d1\u6307\u5357"}),"\n",(0,l.jsx)(e.h3,{id:"\u76ee\u5f55\u7ed3\u6784",children:"\u76ee\u5f55\u7ed3\u6784"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{children:"my-plugin/\n  \u251c\u2500\u2500 plugin.json     # \u63d2\u4ef6\u914d\u7f6e\n  \u251c\u2500\u2500 index.ts        # \u4e3b\u5165\u53e3\u6587\u4ef6\n  \u251c\u2500\u2500 frontend.tsx    # \u524d\u7aef\u7ec4\u4ef6(\u53ef\u9009)\n  \u2514\u2500\u2500 site.ts         # \u7ad9\u70b9\u76f8\u5173\u4ee3\u7801(\u53ef\u9009) \n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u5f00\u53d1\u6d41\u7a0b",children:"\u5f00\u53d1\u6d41\u7a0b"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsx)(e.li,{children:"\u521b\u5efa\u63d2\u4ef6\u914d\u7f6e\u6587\u4ef6"}),"\n",(0,l.jsx)(e.li,{children:"\u5b9e\u73b0\u5fc5\u8981\u7684\u63d2\u4ef6\u65b9\u6cd5"}),"\n",(0,l.jsx)(e.li,{children:"\u7f16\u5199\u6d4b\u8bd5\u7528\u4f8b"}),"\n",(0,l.jsx)(e.li,{children:"\u6784\u5efa\u548c\u6253\u5305"}),"\n",(0,l.jsx)(e.li,{children:"\u53d1\u5e03\u63d2\u4ef6"}),"\n"]}),"\n",(0,l.jsx)(e.h3,{id:"\u6700\u4f73\u5b9e\u8df5",children:"\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsx)(e.li,{children:"\u5408\u7406\u4f7f\u7528\u63d2\u4ef6\u914d\u7f6e\u9879"}),"\n",(0,l.jsx)(e.li,{children:"\u5904\u7406\u5f02\u5e38\u60c5\u51b5"}),"\n",(0,l.jsx)(e.li,{children:"\u6dfb\u52a0\u65e5\u5fd7\u8bb0\u5f55"}),"\n",(0,l.jsx)(e.li,{children:"\u9075\u5faa\u6027\u80fd\u4f18\u5316\u5efa\u8bae"}),"\n",(0,l.jsx)(e.li,{children:"\u505a\u597d\u7248\u672c\u63a7\u5236"}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"\u63d2\u4ef6\u5b89\u5168",children:"\u63d2\u4ef6\u5b89\u5168"}),"\n",(0,l.jsx)(e.h3,{id:"\u6743\u9650\u7ea7\u522b",children:"\u6743\u9650\u7ea7\u522b"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"enum OrganizationPluginsAccessLevel {\n  NONE = 0,    // \u65e0\u6743\u9650\n  CONFIG = 3,  // \u914d\u7f6e\u6743\u9650\n  INSTALL = 6, // \u5b89\u88c5\u6743\u9650\n  ROOT = 9,    // \u6839\u6743\u9650\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u5b89\u5168\u5efa\u8bae",children:"\u5b89\u5168\u5efa\u8bae"}),"\n",(0,l.jsxs)(e.table,{children:[(0,l.jsx)(e.thead,{children:(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.th,{children:"\u9886\u57df"}),(0,l.jsx)(e.th,{children:"\u5efa\u8bae"})]})}),(0,l.jsxs)(e.tbody,{children:[(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"\u6743\u9650\u63a7\u5236"}),(0,l.jsx)(e.td,{children:"\u9075\u5faa\u6700\u5c0f\u6743\u9650\u539f\u5219"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"\u6570\u636e\u9a8c\u8bc1"}),(0,l.jsx)(e.td,{children:"\u9a8c\u8bc1\u6240\u6709\u8f93\u5165\u6570\u636e"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"\u5bc6\u94a5\u7ba1\u7406"}),(0,l.jsx)(e.td,{children:"\u5b89\u5168\u5b58\u50a8\u654f\u611f\u4fe1\u606f"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"\u901a\u4fe1\u5b89\u5168"}),(0,l.jsx)(e.td,{children:"\u4f7f\u7528 HTTPS \u534f\u8bae"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"\u4f9d\u8d56\u7ba1\u7406"}),(0,l.jsx)(e.td,{children:"\u5b9a\u671f\u66f4\u65b0\u4f9d\u8d56\u9879"})]})]})]}),"\n",(0,l.jsx)(e.h2,{id:"\u76d1\u63a7\u548c\u8c03\u8bd5",children:"\u76d1\u63a7\u548c\u8c03\u8bd5"}),"\n",(0,l.jsx)(e.h3,{id:"\u65e5\u5fd7\u7ea7\u522b",children:"\u65e5\u5fd7\u7ea7\u522b"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"enum PluginLogLevel {\n  Full = 0,     // \u6240\u6709\u65e5\u5fd7\n  Log = 1,      // \u9664 debug \u5916\u7684\u6240\u6709\u65e5\u5fd7\n  Info = 2,     // \u9664 log \u548c debug \u5916\u7684\u6240\u6709\u65e5\u5fd7\n  Warn = 3,     // \u4ec5\u8b66\u544a\u548c\u9519\u8bef\n  Critical = 4,  // \u4ec5\u9519\u8bef\u548c\u7cfb\u7edf\u65e5\u5fd7\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u6027\u80fd\u6307\u6807",children:"\u6027\u80fd\u6307\u6807"}),"\n",(0,l.jsxs)(e.table,{children:[(0,l.jsx)(e.thead,{children:(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.th,{children:"\u6307\u6807\u7c7b\u578b"}),(0,l.jsx)(e.th,{children:"\u8bf4\u660e"})]})}),(0,l.jsxs)(e.tbody,{children:[(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"\u5904\u7406\u65f6\u95f4"}),(0,l.jsx)(e.td,{children:"\u4e8b\u4ef6\u5904\u7406\u8017\u65f6"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"\u9519\u8bef\u7387"}),(0,l.jsx)(e.td,{children:"\u5904\u7406\u5931\u8d25\u6bd4\u4f8b"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"\u8d44\u6e90\u4f7f\u7528"}),(0,l.jsx)(e.td,{children:"CPU/\u5185\u5b58\u5360\u7528"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"API\u8c03\u7528"}),(0,l.jsx)(e.td,{children:"\u63a5\u53e3\u8c03\u7528\u7edf\u8ba1"})]})]})]}),"\n",(0,l.jsx)(e.h2,{id:"\u5e38\u89c1\u95ee\u9898",children:"\u5e38\u89c1\u95ee\u9898"}),"\n",(0,l.jsx)(e.h3,{id:"1-\u63d2\u4ef6\u52a0\u8f7d\u5931\u8d25",children:"1. \u63d2\u4ef6\u52a0\u8f7d\u5931\u8d25"}),"\n",(0,l.jsx)(e.mermaid,{value:"graph TD\n    A[\u52a0\u8f7d\u5931\u8d25] --\x3e B{\u68c0\u67e5\u914d\u7f6e}\n    B --\x3e|\u6709\u8bef| C[\u4fee\u6b63\u914d\u7f6e]\n    B --\x3e|\u6b63\u786e| D{\u68c0\u67e5\u4f9d\u8d56}\n    D --\x3e|\u7f3a\u5931| E[\u5b89\u88c5\u4f9d\u8d56]\n    D --\x3e|\u5b8c\u6574| F[\u67e5\u770b\u65e5\u5fd7]"}),"\n",(0,l.jsx)(e.h3,{id:"2-\u6027\u80fd\u95ee\u9898",children:"2. \u6027\u80fd\u95ee\u9898"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4f18\u5316\u4e8b\u4ef6\u5904\u7406\u903b\u8f91"}),"\n",(0,l.jsx)(e.li,{children:"\u51cf\u5c11\u5916\u90e8 API \u8c03\u7528"}),"\n",(0,l.jsx)(e.li,{children:"\u4f7f\u7528\u7f13\u5b58\u673a\u5236"}),"\n"]}),"\n",(0,l.jsx)(e.h3,{id:"3-\u7248\u672c\u517c\u5bb9",children:"3. \u7248\u672c\u517c\u5bb9"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u9075\u5faa\u8bed\u4e49\u5316\u7248\u672c"}),"\n",(0,l.jsx)(e.li,{children:"\u4fdd\u6301\u5411\u540e\u517c\u5bb9"}),"\n",(0,l.jsx)(e.li,{children:"\u53ca\u65f6\u66f4\u65b0\u6587\u6863"}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"api-\u53c2\u8003",children:"API \u53c2\u8003"}),"\n",(0,l.jsx)(e.h3,{id:"\u4e8b\u4ef6\u5bf9\u8c61",children:"\u4e8b\u4ef6\u5bf9\u8c61"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"interface PluginEvent {\n  uuid: string\n  event: string\n  properties: Properties\n  timestamp: string\n  team_id: number\n  distinct_id: string\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"webhook-\u5bf9\u8c61",children:"Webhook \u5bf9\u8c61"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"interface Webhook {\n  url: string\n  headers?: Record<string, string>\n  payload: any\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u914d\u7f6e\u6a21\u5f0f",children:"\u914d\u7f6e\u6a21\u5f0f"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"interface PluginConfigSchema {\n  type: string\n  default?: any\n  required?: boolean\n  title?: string\n  description?: string\n}\n"})}),"\n",(0,l.jsx)(e.h2,{id:"\u793a\u4f8b\u63d2\u4ef6",children:"\u793a\u4f8b\u63d2\u4ef6"}),"\n",(0,l.jsx)(e.h3,{id:"\u57fa\u7840\u63d2\u4ef6\u6a21\u677f",children:"\u57fa\u7840\u63d2\u4ef6\u6a21\u677f"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"export function setupPlugin({ config }) {\n  // \u63d2\u4ef6\u521d\u59cb\u5316\u4ee3\u7801\n}\n\nexport function teardownPlugin() {\n  // \u6e05\u7406\u4ee3\u7801\n}\n\nexport async function onEvent(event) {\n  // \u4e8b\u4ef6\u5904\u7406\u903b\u8f91\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u5b9a\u65f6\u4efb\u52a1\u793a\u4f8b",children:"\u5b9a\u65f6\u4efb\u52a1\u793a\u4f8b"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"export const jobs = {\n  dailyReport: {\n    name: 'daily-report',\n    type: 'schedule',\n    exec: async () => {\n      // \u5b9a\u65f6\u4efb\u52a1\u903b\u8f91\n    }\n  }\n}\n"})}),"\n",(0,l.jsx)(e.h2,{id:"\u66f4\u591a\u8d44\u6e90",children:"\u66f4\u591a\u8d44\u6e90"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://posthog.com/docs/plugins/build",children:"\u63d2\u4ef6\u5f00\u53d1\u6559\u7a0b"})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://posthog.com/docs/api",children:"API \u6587\u6863"})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://github.com/PostHog/plugin-examples",children:"\u793a\u4f8b\u63d2\u4ef6"})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://posthog.com/docs/plugins/best-practices",children:"\u63d2\u4ef6\u6700\u4f73\u5b9e\u8df5"})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://posthog.com/docs/plugins/troubleshooting",children:"\u6545\u969c\u6392\u9664\u6307\u5357"})}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"\u6280\u672f\u5b9e\u73b0",children:"\u6280\u672f\u5b9e\u73b0"}),"\n",(0,l.jsx)(e.h3,{id:"\u63d2\u4ef6\u52a0\u8f7d\u6d41\u7a0b",children:"\u63d2\u4ef6\u52a0\u8f7d\u6d41\u7a0b"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsx)(e.li,{children:"\u63d2\u4ef6\u6587\u4ef6\u8bfb\u53d6"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"function readFileIfExists(baseDir: string, plugin: Plugin, file: string): string | null {\n    const fullPath = path.resolve(baseDir, plugin.url!.substring(5), file)\n    if (fs.existsSync(fullPath)) {\n        return fs.readFileSync(fullPath).toString()\n    }\n    return null\n}\n"})}),"\n",(0,l.jsxs)(e.ol,{start:"2",children:["\n",(0,l.jsx)(e.li,{children:"\u63d2\u4ef6\u521d\u59cb\u5316"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"async function loadPlugin(hub: Hub, pluginConfig: PluginConfig): Promise<boolean> {\n    // 1. \u68c0\u67e5\u63d2\u4ef6\u7c7b\u578b\n    if (plugin.plugin_type === 'inline') {\n        await pluginConfig.instance?.initialize!('', pluginDigest(plugin))\n        return true\n    }\n\n    // 2. \u52a0\u8f7d\u914d\u7f6e\n    const configJson = isLocalPlugin\n        ? readFileIfExists(hub.BASE_DIR, plugin, 'plugin.json')\n        : plugin.source__plugin_json\n\n    // 3. \u52a0\u8f7d\u6e90\u4ee3\u7801\n    const pluginSource = isLocalPlugin\n        ? config['main']\n            ? readFileIfExists(hub.BASE_DIR, plugin, config['main'])\n            : readFileIfExists(hub.BASE_DIR, plugin, 'index.js')\n        : plugin.source__index_ts\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u865a\u62df\u673a\u5b9e\u73b0",children:"\u865a\u62df\u673a\u5b9e\u73b0"}),"\n",(0,l.jsx)(e.p,{children:"PostHog \u4f7f\u7528 VM2 \u6765\u8fd0\u884c\u63d2\u4ef6\u4ee3\u7801,\u786e\u4fdd\u5b89\u5168\u6027\u548c\u9694\u79bb\u6027:"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"export class LazyPluginVM implements PluginInstance {\n    // \u63d2\u4ef6VM\u5b9e\u4f8b\n    private vm: VM\n    \n    // \u63d2\u4ef6\u72b6\u6001\n    private ready: boolean\n    private inErroredState: boolean\n    \n    // \u91cd\u8bd5\u673a\u5236\n    private totalInitAttemptsCounter: number\n    private initRetryTimeout: NodeJS.Timeout | null\n\n    // \u521d\u59cb\u5316VM\n    private initVm() {\n        this.resolveInternalVm = new Promise((resolve) => {\n            // VM\u521d\u59cb\u5316\u903b\u8f91\n        })\n    }\n\n    // \u8bbe\u7f6e\u63d2\u4ef6\n    public async setupPluginIfNeeded(): Promise<boolean> {\n        if (!this.ready) {\n            const vm = (await this.resolveInternalVm)?.vm\n            try {\n                await this._setupPlugin(vm)\n            } catch (error) {\n                return false\n            }\n        }\n        return true\n    }\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u63d2\u4ef6\u80fd\u529b\u68c0\u6d4b",children:"\u63d2\u4ef6\u80fd\u529b\u68c0\u6d4b"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"async function updatePluginCapabilitiesIfNeeded(vm: PluginConfigVMResponse): Promise<void> {\n    const capabilities = getVMPluginCapabilities(vm)\n    if (!equal(capabilities, this.pluginConfig.plugin?.capabilities)) {\n        await setPluginCapabilities(this.hub, this.pluginConfig.plugin!.id, capabilities)\n        this.pluginConfig.plugin!.capabilities = capabilities\n    }\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u9519\u8bef\u5904\u7406",children:"\u9519\u8bef\u5904\u7406"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsx)(e.li,{children:"\u521d\u59cb\u5316\u9519\u8bef"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"class SetupPluginError extends Error {\n    constructor(message: string) {\n        super(message)\n        this.name = 'SetupPluginError'\n    }\n}\n"})}),"\n",(0,l.jsxs)(e.ol,{start:"2",children:["\n",(0,l.jsx)(e.li,{children:"\u9519\u8bef\u91cd\u8bd5\u673a\u5236"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"const VM_INIT_MAX_RETRIES = 5\nconst INITIALIZATION_RETRY_MULTIPLIER = 2\nconst INITIALIZATION_RETRY_BASE_MS = 5000\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u6027\u80fd\u76d1\u63a7",children:"\u6027\u80fd\u76d1\u63a7"}),"\n",(0,l.jsx)(e.p,{children:"\u4f7f\u7528 Prometheus \u6307\u6807\u6536\u96c6\u63d2\u4ef6\u6027\u80fd\u6570\u636e:"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"const pluginSetupMsSummary = new Summary({\n    name: 'plugin_setup_ms',\n    help: 'Time to setup plugins',\n    labelNames: ['plugin_id', 'status'],\n})\n\nconst pluginDisabledBySystemCounter = new Counter({\n    name: 'plugin_disabled_by_system',\n    help: 'Count of plugins disabled by the system',\n    labelNames: ['plugin_id'],\n})\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u65e5\u5fd7\u7cfb\u7edf",children:"\u65e5\u5fd7\u7cfb\u7edf"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"async function createLogEntry(\n    message: string, \n    logType = PluginLogEntryType.Info\n): Promise<void> {\n    await this.hub.db.queuePluginLogEntry({\n        pluginConfig: this.pluginConfig,\n        message: message,\n        source: PluginLogEntrySource.System,\n        type: logType,\n        instanceId: this.hub.instanceId,\n    })\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u5b89\u5168\u9650\u5236",children:"\u5b89\u5168\u9650\u5236"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsx)(e.li,{children:"\u81ea\u6211\u590d\u5236\u4fdd\u62a4"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"if (this.pluginConfig.plugin?.name == 'Replicator') {\n    // \u9632\u6b62\u63d2\u4ef6\u81ea\u6211\u590d\u5236\u5bfc\u81f4\u65e0\u9650\u5faa\u73af\n    const isAllowed = team?.uuid == ALLOWED_UUID && host == ALLOWED_HOST\n    if (!isAllowed && team?.api_token.trim() == apiKey.trim()) {\n        throw Error('Self replication is not allowed')\n    }\n}\n"})}),"\n",(0,l.jsxs)(e.ol,{start:"2",children:["\n",(0,l.jsx)(e.li,{children:"\u8d44\u6e90\u9650\u5236"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"const RESOURCE_LIMITS = {\n    maxMemory: 100 * 1024 * 1024, // 100MB\n    timeout: 1000 * 60, // 1\u5206\u949f\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u63d2\u4ef6\u901a\u4fe1",children:"\u63d2\u4ef6\u901a\u4fe1"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsx)(e.li,{children:"\u4e8b\u4ef6\u603b\u7ebf"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"interface EventBus {\n    emit(event: string, payload: any): void\n    on(event: string, handler: (payload: any) => void): void\n}\n"})}),"\n",(0,l.jsxs)(e.ol,{start:"2",children:["\n",(0,l.jsx)(e.li,{children:"\u63d2\u4ef6\u95f4\u901a\u4fe1"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"async function sendToPlugin(targetPlugin: string, message: any) {\n    await this.hub.pluginBus.emit(`plugin:${targetPlugin}`, message)\n}\n"})}),"\n",(0,l.jsx)(e.h2,{id:"\u4e8b\u4ef6\u5904\u7406\u8be6\u89e3",children:"\u4e8b\u4ef6\u5904\u7406\u8be6\u89e3"}),"\n",(0,l.jsx)(e.h3,{id:"\u4e8b\u4ef6\u7c7b\u578b",children:"\u4e8b\u4ef6\u7c7b\u578b"}),"\n",(0,l.jsx)(e.p,{children:"PostHog \u63d2\u4ef6\u7cfb\u7edf\u652f\u6301\u4ee5\u4e0b\u51e0\u79cd\u4e3b\u8981\u4e8b\u4ef6\u7c7b\u578b\uff1a"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsx)(e.li,{children:"\u539f\u59cb\u4e8b\u4ef6 (PluginEvent)"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"interface PluginEvent {\n    uuid: string           // \u4e8b\u4ef6\u552f\u4e00\u6807\u8bc6\n    event: string         // \u4e8b\u4ef6\u540d\u79f0\n    properties: Properties // \u4e8b\u4ef6\u5c5e\u6027\n    timestamp: string     // \u4e8b\u4ef6\u65f6\u95f4\u6233\n    team_id: number      // \u56e2\u961fID\n    distinct_id: string   // \u7528\u6237\u552f\u4e00\u6807\u8bc6\n}\n"})}),"\n",(0,l.jsxs)(e.ol,{start:"2",children:["\n",(0,l.jsx)(e.li,{children:"\u5904\u7406\u540e\u4e8b\u4ef6 (ProcessedPluginEvent)"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"interface ProcessedPluginEvent extends PluginEvent {\n    // \u5305\u542b\u4e86\u66f4\u591a\u5904\u7406\u540e\u7684\u4fe1\u606f\n    person?: {\n        uuid: string\n        properties: Properties\n        created_at: string\n    }\n    group_properties?: Record<string, Properties>\n}\n"})}),"\n",(0,l.jsxs)(e.ol,{start:"3",children:["\n",(0,l.jsx)(e.li,{children:"PostHog \u4e8b\u4ef6 (PostHogEvent)"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"interface PostHogEvent {\n    // \u7528\u4e8e\u65b0\u7248\u672c\u63d2\u4ef6\u7684\u4e8b\u4ef6\u683c\u5f0f\n    distinctId: string\n    properties: Properties\n    event: string\n    timestamp: string\n    teamId: number\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u4e8b\u4ef6\u5904\u7406\u6d41\u7a0b",children:"\u4e8b\u4ef6\u5904\u7406\u6d41\u7a0b"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsx)(e.li,{children:"\u4e8b\u4ef6\u63a5\u6536\u9636\u6bb5"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"// 1. \u4e8b\u4ef6\u8fdb\u5165\u7cfb\u7edf\ninterface PreIngestionEvent {\n    eventUuid: string\n    event: string\n    teamId: number\n    projectId: number\n    distinctId: string\n    properties: Properties\n    timestamp: string\n}\n"})}),"\n",(0,l.jsxs)(e.ol,{start:"2",children:["\n",(0,l.jsx)(e.li,{children:"\u4e8b\u4ef6\u5904\u7406\u9636\u6bb5"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"// 2. \u63d2\u4ef6\u5904\u7406\u4e8b\u4ef6\nasync function processEvent(event: PluginEvent): Promise<PluginEvent> {\n    // \u63d2\u4ef6\u53ef\u4ee5:\n    // - \u4fee\u6539\u4e8b\u4ef6\u5c5e\u6027\n    // - \u6dfb\u52a0\u65b0\u5c5e\u6027\n    // - \u8fc7\u6ee4\u4e8b\u4ef6\n    return event\n}\n\n// 3. \u4e8b\u4ef6\u540e\u5904\u7406\nasync function onEvent(event: ProcessedPluginEvent): Promise<void> {\n    // \u63d2\u4ef6\u53ef\u4ee5:\n    // - \u53d1\u9001\u4e8b\u4ef6\u5230\u5916\u90e8\u7cfb\u7edf\n    // - \u89e6\u53d1\u5176\u4ed6\u64cd\u4f5c\n    // - \u8bb0\u5f55\u6570\u636e\n}\n"})}),"\n",(0,l.jsxs)(e.ol,{start:"3",children:["\n",(0,l.jsx)(e.li,{children:"Webhook \u5904\u7406"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"// 4. Webhook \u7ec4\u88c5\nfunction composeWebhook(event: PostHogEvent): Webhook | null {\n    return {\n        url: string,\n        headers?: Record<string, string>,\n        payload: any\n    }\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u7279\u6b8a\u4e8b\u4ef6",children:"\u7279\u6b8a\u4e8b\u4ef6"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsx)(e.li,{children:"\u7cfb\u7edf\u4e8b\u4ef6"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"const SYSTEM_EVENTS = {\n    $set: '\u8bbe\u7f6e\u7528\u6237\u5c5e\u6027',\n    $identify: '\u8bc6\u522b\u7528\u6237',\n    $create_alias: '\u521b\u5efa\u522b\u540d',\n    $merge_dangerously: '\u5408\u5e76\u7528\u6237',\n    $groupidentify: '\u8bc6\u522b\u7ec4'\n}\n"})}),"\n",(0,l.jsxs)(e.ol,{start:"2",children:["\n",(0,l.jsx)(e.li,{children:"\u76d1\u63a7\u4e8b\u4ef6"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"interface PluginLogEntry {\n    id: string\n    team_id: number\n    plugin_id: number\n    timestamp: string\n    source: PluginLogEntrySource\n    type: PluginLogEntryType\n    message: string\n    instance_id: string\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u4e8b\u4ef6\u5c5e\u6027\u5904\u7406",children:"\u4e8b\u4ef6\u5c5e\u6027\u5904\u7406"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsx)(e.li,{children:"\u5c5e\u6027\u7c7b\u578b"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"enum PropertyType {\n    DateTime = 'DateTime',\n    String = 'String',\n    Numeric = 'Numeric',\n    Boolean = 'Boolean',\n    Duration = 'Duration',\n    Selector = 'Selector',\n    Cohort = 'Cohort'\n}\n"})}),"\n",(0,l.jsxs)(e.ol,{start:"2",children:["\n",(0,l.jsx)(e.li,{children:"\u5c5e\u6027\u5b9a\u4e49"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"interface PropertyDefinition {\n    name: string\n    type: PropertyType\n    required?: boolean\n    default?: any\n    description?: string\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u4e8b\u4ef6\u5904\u7406\u80fd\u529b",children:"\u4e8b\u4ef6\u5904\u7406\u80fd\u529b"}),"\n",(0,l.jsx)(e.p,{children:"\u63d2\u4ef6\u670d\u52a1\u5668\u6839\u636e\u4e0d\u540c\u6a21\u5f0f\u63d0\u4f9b\u4e0d\u540c\u7684\u4e8b\u4ef6\u5904\u7406\u80fd\u529b\uff1a"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"enum PluginServerMode {\n    ingestion = 'ingestion',           // \u4e8b\u4ef6\u63a5\u6536\n    async_onevent = 'async-onevent',   // \u5f02\u6b65\u4e8b\u4ef6\u5904\u7406\n    async_webhooks = 'async-webhooks', // \u5f02\u6b65Webhook\u5904\u7406\n    jobs = 'jobs',                     // \u4efb\u52a1\u5904\u7406\n    scheduler = 'scheduler'            // \u8c03\u5ea6\u5668\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u4e8b\u4ef6\u5904\u7406\u6307\u6807",children:"\u4e8b\u4ef6\u5904\u7406\u6307\u6807"}),"\n",(0,l.jsx)(e.p,{children:"\u7cfb\u7edf\u4f1a\u6536\u96c6\u4ee5\u4e0b\u4e8b\u4ef6\u5904\u7406\u6307\u6807\uff1a"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsx)(e.li,{children:"\u6027\u80fd\u6307\u6807"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"const pluginSetupMsSummary = new Summary({\n    name: 'plugin_setup_ms',\n    help: '\u63d2\u4ef6\u8bbe\u7f6e\u65f6\u95f4',\n    labelNames: ['plugin_id', 'status']\n})\n"})}),"\n",(0,l.jsxs)(e.ol,{start:"2",children:["\n",(0,l.jsx)(e.li,{children:"\u9519\u8bef\u6307\u6807"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"const pluginDisabledBySystemCounter = new Counter({\n    name: 'plugin_disabled_by_system',\n    help: '\u7cfb\u7edf\u7981\u7528\u7684\u63d2\u4ef6\u6570\u91cf',\n    labelNames: ['plugin_id']\n})\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u4e8b\u4ef6\u5904\u7406\u6700\u4f73\u5b9e\u8df5",children:"\u4e8b\u4ef6\u5904\u7406\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsxs)(e.li,{children:["\n",(0,l.jsx)(e.p,{children:"\u6027\u80fd\u4f18\u5316"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4f7f\u7528\u6279\u91cf\u5904\u7406"}),"\n",(0,l.jsx)(e.li,{children:"\u5b9e\u73b0\u7f13\u5b58\u673a\u5236"}),"\n",(0,l.jsx)(e.li,{children:"\u907f\u514d\u540c\u6b65\u963b\u585e"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\n",(0,l.jsx)(e.p,{children:"\u9519\u8bef\u5904\u7406"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5b9e\u73b0\u91cd\u8bd5\u673a\u5236"}),"\n",(0,l.jsx)(e.li,{children:"\u8bb0\u5f55\u8be6\u7ec6\u65e5\u5fd7"}),"\n",(0,l.jsx)(e.li,{children:"\u8bbe\u7f6e\u8d85\u65f6\u9650\u5236"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\n",(0,l.jsx)(e.p,{children:"\u6570\u636e\u9a8c\u8bc1"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u9a8c\u8bc1\u4e8b\u4ef6\u683c\u5f0f"}),"\n",(0,l.jsx)(e.li,{children:"\u68c0\u67e5\u5fc5\u8981\u5b57\u6bb5"}),"\n",(0,l.jsx)(e.li,{children:"\u6e05\u7406\u65e0\u6548\u6570\u636e"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:["\n",(0,l.jsx)(e.p,{children:"\u5b89\u5168\u8003\u8651"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u9a8c\u8bc1\u6570\u636e\u6765\u6e90"}),"\n",(0,l.jsx)(e.li,{children:"\u9650\u5236\u8d44\u6e90\u4f7f\u7528"}),"\n",(0,l.jsx)(e.li,{children:"\u52a0\u5bc6\u654f\u611f\u4fe1\u606f"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"\u63d2\u4ef6\u670d\u52a1\u5668\u5b9e\u73b0",children:"\u63d2\u4ef6\u670d\u52a1\u5668\u5b9e\u73b0"}),"\n",(0,l.jsx)(e.h3,{id:"\u670d\u52a1\u5668\u67b6\u6784",children:"\u670d\u52a1\u5668\u67b6\u6784"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsx)(e.li,{children:"\u4e3b\u7ebf\u7a0b"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"// \u4e3b\u7ebf\u7a0b\u8d1f\u8d23:\n1. pubSub - \u57fa\u4e8eRedis\u7684\u53d1\u5e03\u8ba2\u9605\u673a\u5236,\u7528\u4e8e\u5728\u4e3bPostHog\u5e94\u7528\u53d1\u5e03\u6d88\u606f\u65f6\u91cd\u65b0\u52a0\u8f7d\u63d2\u4ef6\n2. hub - \u7ba1\u7406\u6570\u636e\u5e93\u548c\u961f\u5217\u8fde\u63a5(ClickHouse, Kafka, Postgres, Redis)\n3. piscina - \u7ebf\u7a0b\u6c60\u7ba1\u7406\u5668\n"})}),"\n",(0,l.jsxs)(e.ol,{start:"2",children:["\n",(0,l.jsx)(e.li,{children:"\u5de5\u4f5c\u7ebf\u7a0b"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"// \u6bcf\u4e2a\u5de5\u4f5c\u7ebf\u7a0b\u8fd0\u884c:\n1. TASKS_PER_WORKER \u4e2a\u4efb\u52a1\n2. \u72ec\u7acb\u7684Hub\u5b9e\u4f8b\n3. \u72ec\u7acb\u7684VM\u73af\u5883\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u670d\u52a1\u5668\u6a21\u5f0f",children:"\u670d\u52a1\u5668\u6a21\u5f0f"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"enum PluginServerMode {\n    all_v2 = 'all-v2',               // \u5b8c\u6574\u529f\u80fd\n    ingestion = 'ingestion',         // \u6570\u636e\u63a5\u6536\n    async_onevent = 'async-onevent', // \u5f02\u6b65\u4e8b\u4ef6\u5904\u7406\n    async_webhooks = 'async-webhooks',// \u5f02\u6b65Webhook\n    jobs = 'jobs',                   // \u4efb\u52a1\u5904\u7406\n    scheduler = 'scheduler',         // \u8c03\u5ea6\u5668\n    analytics_ingestion = 'analytics-ingestion' // \u5206\u6790\u6570\u636e\u63a5\u6536\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u63d2\u4ef6\u52a0\u8f7d\u6d41\u7a0b-1",children:"\u63d2\u4ef6\u52a0\u8f7d\u6d41\u7a0b"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsx)(e.li,{children:"\u521d\u59cb\u5316\u9636\u6bb5"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"async function startPluginsServer(\n    config: Partial<PluginsServerConfig>,\n    capabilities?: PluginServerCapabilities\n): Promise<ServerInstance> {\n    // 1. \u521b\u5efa\u670d\u52a1\u5668\u5b9e\u4f8b\n    // 2. \u521d\u59cb\u5316\u6570\u636e\u5e93\u8fde\u63a5\n    // 3. \u542f\u52a8\u5de5\u4f5c\u7ebf\u7a0b\n    // 4. \u52a0\u8f7d\u63d2\u4ef6\n}\n"})}),"\n",(0,l.jsxs)(e.ol,{start:"2",children:["\n",(0,l.jsx)(e.li,{children:"\u63d2\u4ef6\u52a0\u8f7d"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"async function loadPlugin(hub: Hub, pluginConfig: PluginConfig): Promise<boolean> {\n    // 1. \u68c0\u67e5\u63d2\u4ef6\u7c7b\u578b\n    if (plugin.plugin_type === 'inline') {\n        return initializeInlinePlugin()\n    }\n\n    // 2. \u52a0\u8f7d\u914d\u7f6e\n    const configJson = loadPluginConfig()\n    \n    // 3. \u52a0\u8f7d\u6e90\u4ee3\u7801\n    const pluginSource = loadPluginSource()\n    \n    // 4. \u521d\u59cb\u5316VM\n    const vm = createPluginConfigVM()\n}\n"})}),"\n",(0,l.jsxs)(e.ol,{start:"3",children:["\n",(0,l.jsx)(e.li,{children:"VM\u521d\u59cb\u5316"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"class LazyPluginVM implements PluginInstance {\n    private initVm() {\n        this.resolveInternalVm = new Promise((resolve) => {\n            // 1. \u521b\u5efaVM\u5b9e\u4f8b\n            const vm = createPluginConfigVM()\n            \n            // 2. \u68c0\u6d4b\u63d2\u4ef6\u80fd\u529b\n            await this.updatePluginCapabilitiesIfNeeded(vm)\n            \n            // 3. \u8bbe\u7f6e\u63d2\u4ef6\n            if (shouldSetupNow) {\n                await this._setupPlugin(vm.vm)\n            }\n        })\n    }\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u63d2\u4ef6\u6267\u884c\u73af\u5883",children:"\u63d2\u4ef6\u6267\u884c\u73af\u5883"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsx)(e.li,{children:"VM\u914d\u7f6e"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"function createPluginConfigVM(\n    hub: Hub,\n    pluginConfig: PluginConfig,\n    indexJs: string\n): PluginConfigVMResponse {\n    // 1. \u521b\u5efa\u9694\u79bb\u7684VM\u73af\u5883\n    const vm = new VM({\n        sandbox: {\n            // \u6ce8\u5165\u5168\u5c40\u5bf9\u8c61\n            console,\n            exports,\n            require: createRequire()\n        }\n    })\n\n    // 2. \u6ce8\u5165\u63d2\u4ef6API\n    const methods = {\n        setupPlugin: bindMeta('setupPlugin'),\n        teardownPlugin: bindMeta('teardownPlugin'),\n        onEvent: bindMeta('onEvent'),\n        processEvent: bindMeta('processEvent'),\n        composeWebhook: bindMeta('composeWebhook')\n    }\n\n    // 3. \u6ce8\u5165\u4efb\u52a1API\n    const tasks = {\n        schedule: {},\n        job: {}\n    }\n}\n"})}),"\n",(0,l.jsxs)(e.ol,{start:"2",children:["\n",(0,l.jsx)(e.li,{children:"\u5b89\u5168\u9650\u5236"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"const VM_SECURITY_SETTINGS = {\n    timeout: 1000 * 60,          // 60\u79d2\u8d85\u65f6\n    allowAsync: true,            // \u5141\u8bb8\u5f02\u6b65\n    sandbox: true,               // \u6c99\u7bb1\u73af\u5883\n    eval: false,                 // \u7981\u6b62eval\n    wasm: false,                // \u7981\u6b62WebAssembly\n    fixAsync: true              // \u4fee\u590d\u5f02\u6b65\u95ee\u9898\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u63d2\u4ef6\u901a\u4fe1\u673a\u5236",children:"\u63d2\u4ef6\u901a\u4fe1\u673a\u5236"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsx)(e.li,{children:"Redis PubSub"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"class PubSub {\n    // \u53d1\u5e03\u6d88\u606f\n    async publish(channel: string, message: any): Promise<void>\n    \n    // \u8ba2\u9605\u6d88\u606f\n    async subscribe(channel: string, handler: (message: any) => void): Promise<void>\n}\n"})}),"\n",(0,l.jsxs)(e.ol,{start:"2",children:["\n",(0,l.jsx)(e.li,{children:"\u4e8b\u4ef6\u603b\u7ebf"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"class EventBus {\n    // \u53d1\u9001\u4e8b\u4ef6\n    async emit(event: string, payload: any): Promise<void>\n    \n    // \u76d1\u542c\u4e8b\u4ef6\n    async on(event: string, handler: (payload: any) => void): Promise<void>\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u9519\u8bef\u5904\u7406\u673a\u5236",children:"\u9519\u8bef\u5904\u7406\u673a\u5236"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsx)(e.li,{children:"\u91cd\u8bd5\u673a\u5236"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"const RETRY_SCHEDULE = {\n    maxRetries: 5,\n    baseDelay: 5000,\n    maxDelay: 60000,\n    factor: 2\n}\n"})}),"\n",(0,l.jsxs)(e.ol,{start:"2",children:["\n",(0,l.jsx)(e.li,{children:"\u9519\u8bef\u76d1\u63a7"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"interface PluginError {\n    message: string\n    time: string\n    name?: string\n    stack?: string\n    event?: PluginEvent | null\n}\n"})}),"\n",(0,l.jsx)(e.h3,{id:"\u6027\u80fd\u4f18\u5316",children:"\u6027\u80fd\u4f18\u5316"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsx)(e.li,{children:"\u6279\u5904\u7406"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"interface BatchProcessor {\n    // \u6279\u91cf\u5904\u7406\u4e8b\u4ef6\n    processBatch(events: PluginEvent[]): Promise<void>\n    \n    // \u5237\u65b0\u6279\u5904\u7406\n    flush(): Promise<void>\n}\n"})}),"\n",(0,l.jsxs)(e.ol,{start:"2",children:["\n",(0,l.jsx)(e.li,{children:"\u7f13\u5b58\u673a\u5236"}),"\n"]}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-typescript",children:"interface CacheManager {\n    // \u83b7\u53d6\u7f13\u5b58\n    get(key: string): Promise<any>\n    \n    // \u8bbe\u7f6e\u7f13\u5b58\n    set(key: string, value: any, ttl?: number): Promise<void>\n}\n"})})]})}function o(n={}){const{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,l.jsx)(e,{...n,children:(0,l.jsx)(h,{...n})}):h(n)}},28453:(n,e,i)=>{i.d(e,{R:()=>d,x:()=>t});var s=i(96540);const l={},r=s.createContext(l);function d(n){const e=s.useContext(r);return s.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function t(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(l):n.components||l:d(n.components),s.createElement(r.Provider,{value:e},n.children)}}}]);