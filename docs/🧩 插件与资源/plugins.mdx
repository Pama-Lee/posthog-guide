# ğŸ”Œ PostHog æ’ä»¶ç³»ç»Ÿ

## æ¦‚è¿°

PostHog æ’ä»¶ç³»ç»Ÿæ˜¯ä¸€ä¸ªå¼ºå¤§è€Œçµæ´»çš„æ‰©å±•æœºåˆ¶ï¼Œè®©å¼€å‘è€…èƒ½å¤Ÿé€šè¿‡æ’ä»¶æ¥æ‰©å±•å’Œè‡ªå®šä¹‰ PostHog çš„åŠŸèƒ½ã€‚æ’ä»¶å¯ä»¥:

- å¤„ç†äº‹ä»¶æµ
- æ‰§è¡Œå®šæ—¶ä»»åŠ¡
- é›†æˆå¤–éƒ¨ç³»ç»Ÿ
- è‡ªå®šä¹‰æ•°æ®å¤„ç†
- æ‰©å±•ç”¨æˆ·ç•Œé¢

## æ’ä»¶ç±»å‹

PostHog æ”¯æŒä»¥ä¸‹å‡ ç§ç±»å‹çš„æ’ä»¶:

| ç±»å‹ | æè¿° | ä½¿ç”¨åœºæ™¯ |
|------|------|----------|
| `local` | æœ¬åœ°å¼€å‘çš„æ’ä»¶ | å¼€å‘å’Œæµ‹è¯•é˜¶æ®µ |
| `repository` | ä»ä»£ç ä»“åº“å®‰è£…çš„æ’ä»¶ | ç”Ÿäº§ç¯å¢ƒéƒ¨ç½² |
| `custom` | è‡ªå®šä¹‰æ’ä»¶ | ç‰¹å®šéœ€æ±‚å®šåˆ¶ |
| `source` | æºä»£ç å½¢å¼çš„æ’ä»¶ | äºŒæ¬¡å¼€å‘ |
| `inline` | å†…è”æ’ä»¶ | ç®€å•åŠŸèƒ½æ‰©å±• |

## æ’ä»¶é…ç½®

### plugin.json

æ¯ä¸ªæ’ä»¶éƒ½éœ€è¦ä¸€ä¸ª `plugin.json` é…ç½®æ–‡ä»¶:

```json
{
  "name": "æ’ä»¶åç§°",
  "description": "æ’ä»¶æè¿°",
  "url": "æ’ä»¶ä¸»é¡µ",
  "main": "å…¥å£æ–‡ä»¶",
  "lib": "åº“æ–‡ä»¶",
  "config": {
    // æ’ä»¶é…ç½®é¡¹å®šä¹‰
  }
}
```

### é…ç½®é¡¹ç±»å‹

| ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `string` | å­—ç¬¦ä¸² | ç”¨æˆ·åã€URL |
| `boolean` | å¸ƒå°”å€¼ | å¼€å…³æ ‡å¿— |
| `json` | JSONå¯¹è±¡ | å¤æ‚é…ç½® |
| `number` | æ•°å­— | é˜ˆå€¼ã€æ•°é‡ |
| `date` | æ—¥æœŸ | å¼€å§‹æ—¶é—´ |
| `daterange` | æ—¥æœŸèŒƒå›´ | ç»Ÿè®¡å‘¨æœŸ |

## æ’ä»¶åŠŸèƒ½

### äº‹ä»¶å¤„ç†

æ’ä»¶å¯ä»¥é€šè¿‡å®ç°ä»¥ä¸‹æ–¹æ³•æ¥å¤„ç†äº‹ä»¶:

```typescript
interface PluginMethods {
  // æ’ä»¶åˆå§‹åŒ–
  setupPlugin?: () => Promise<void>
  
  // æ’ä»¶æ¸…ç†
  teardownPlugin?: () => Promise<void>
  
  // è·å–æ’ä»¶è®¾ç½®
  getSettings?: () => PluginSettings
  
  // å¤„ç†äº‹ä»¶
  onEvent?: (event: ProcessedPluginEvent) => Promise<void>
  
  // ç»„è£… Webhook
  composeWebhook?: (event: PostHogEvent) => Webhook | null
  
  // å¤„ç†äº‹ä»¶
  processEvent?: (event: PluginEvent) => Promise<PluginEvent>
}
```

### å®šæ—¶ä»»åŠ¡

```typescript
interface PluginTask {
  name: string
  type: 'job' | 'schedule'
  exec: (payload?: Record<string, any>) => Promise<any>
}
```

### æ’ä»¶èƒ½åŠ›

```typescript
interface PluginCapabilities {
  jobs?: string[]  // æ”¯æŒçš„ä»»åŠ¡
  scheduled_tasks?: string[] // æ”¯æŒçš„å®šæ—¶ä»»åŠ¡
  methods?: string[] // æ”¯æŒçš„æ–¹æ³•
}
```

## æ’ä»¶ç”Ÿå‘½å‘¨æœŸ

```mermaid
graph TD
    A[åŠ è½½é˜¶æ®µ] --> B[è¿è¡Œé˜¶æ®µ]
    B --> C[å¸è½½é˜¶æ®µ]
    A --> D[è¯»å–é…ç½®]
    A --> E[åˆå§‹åŒ–å®ä¾‹]
    A --> F[è°ƒç”¨ setupPlugin]
    B --> G[å¤„ç†äº‹ä»¶]
    B --> H[æ‰§è¡Œä»»åŠ¡]
    B --> I[è°ƒç”¨æ–¹æ³•]
    C --> J[è°ƒç”¨ teardownPlugin]
    C --> K[æ¸…ç†èµ„æº]
```

## æ’ä»¶å¼€å‘æŒ‡å—

### ç›®å½•ç»“æ„

```
my-plugin/
  â”œâ”€â”€ plugin.json     # æ’ä»¶é…ç½®
  â”œâ”€â”€ index.ts        # ä¸»å…¥å£æ–‡ä»¶
  â”œâ”€â”€ frontend.tsx    # å‰ç«¯ç»„ä»¶(å¯é€‰)
  â””â”€â”€ site.ts         # ç«™ç‚¹ç›¸å…³ä»£ç (å¯é€‰) 
```

### å¼€å‘æµç¨‹

1. åˆ›å»ºæ’ä»¶é…ç½®æ–‡ä»¶
2. å®ç°å¿…è¦çš„æ’ä»¶æ–¹æ³•
3. ç¼–å†™æµ‹è¯•ç”¨ä¾‹
4. æ„å»ºå’Œæ‰“åŒ…
5. å‘å¸ƒæ’ä»¶

### æœ€ä½³å®è·µ

1. åˆç†ä½¿ç”¨æ’ä»¶é…ç½®é¡¹
2. å¤„ç†å¼‚å¸¸æƒ…å†µ
3. æ·»åŠ æ—¥å¿—è®°å½•
4. éµå¾ªæ€§èƒ½ä¼˜åŒ–å»ºè®®
5. åšå¥½ç‰ˆæœ¬æ§åˆ¶

## æ’ä»¶å®‰å…¨

### æƒé™çº§åˆ«

```typescript
enum OrganizationPluginsAccessLevel {
  NONE = 0,    // æ— æƒé™
  CONFIG = 3,  // é…ç½®æƒé™
  INSTALL = 6, // å®‰è£…æƒé™
  ROOT = 9,    // æ ¹æƒé™
}
```

### å®‰å…¨å»ºè®®

| é¢†åŸŸ | å»ºè®® |
|------|------|
| æƒé™æ§åˆ¶ | éµå¾ªæœ€å°æƒé™åŸåˆ™ |
| æ•°æ®éªŒè¯ | éªŒè¯æ‰€æœ‰è¾“å…¥æ•°æ® |
| å¯†é’¥ç®¡ç† | å®‰å…¨å­˜å‚¨æ•æ„Ÿä¿¡æ¯ |
| é€šä¿¡å®‰å…¨ | ä½¿ç”¨ HTTPS åè®® |
| ä¾èµ–ç®¡ç† | å®šæœŸæ›´æ–°ä¾èµ–é¡¹ |

## ç›‘æ§å’Œè°ƒè¯•

### æ—¥å¿—çº§åˆ«

```typescript
enum PluginLogLevel {
  Full = 0,     // æ‰€æœ‰æ—¥å¿—
  Log = 1,      // é™¤ debug å¤–çš„æ‰€æœ‰æ—¥å¿—
  Info = 2,     // é™¤ log å’Œ debug å¤–çš„æ‰€æœ‰æ—¥å¿—
  Warn = 3,     // ä»…è­¦å‘Šå’Œé”™è¯¯
  Critical = 4,  // ä»…é”™è¯¯å’Œç³»ç»Ÿæ—¥å¿—
}
```

### æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ç±»å‹ | è¯´æ˜ |
|----------|------|
| å¤„ç†æ—¶é—´ | äº‹ä»¶å¤„ç†è€—æ—¶ |
| é”™è¯¯ç‡ | å¤„ç†å¤±è´¥æ¯”ä¾‹ |
| èµ„æºä½¿ç”¨ | CPU/å†…å­˜å ç”¨ |
| APIè°ƒç”¨ | æ¥å£è°ƒç”¨ç»Ÿè®¡ |

## å¸¸è§é—®é¢˜

### 1. æ’ä»¶åŠ è½½å¤±è´¥
```mermaid
graph TD
    A[åŠ è½½å¤±è´¥] --> B{æ£€æŸ¥é…ç½®}
    B -->|æœ‰è¯¯| C[ä¿®æ­£é…ç½®]
    B -->|æ­£ç¡®| D{æ£€æŸ¥ä¾èµ–}
    D -->|ç¼ºå¤±| E[å®‰è£…ä¾èµ–]
    D -->|å®Œæ•´| F[æŸ¥çœ‹æ—¥å¿—]
```

### 2. æ€§èƒ½é—®é¢˜
- ä¼˜åŒ–äº‹ä»¶å¤„ç†é€»è¾‘
- å‡å°‘å¤–éƒ¨ API è°ƒç”¨
- ä½¿ç”¨ç¼“å­˜æœºåˆ¶

### 3. ç‰ˆæœ¬å…¼å®¹
- éµå¾ªè¯­ä¹‰åŒ–ç‰ˆæœ¬
- ä¿æŒå‘åå…¼å®¹
- åŠæ—¶æ›´æ–°æ–‡æ¡£

## API å‚è€ƒ

### äº‹ä»¶å¯¹è±¡

```typescript
interface PluginEvent {
  uuid: string
  event: string
  properties: Properties
  timestamp: string
  team_id: number
  distinct_id: string
}
```

### Webhook å¯¹è±¡

```typescript
interface Webhook {
  url: string
  headers?: Record<string, string>
  payload: any
}
```

### é…ç½®æ¨¡å¼

```typescript
interface PluginConfigSchema {
  type: string
  default?: any
  required?: boolean
  title?: string
  description?: string
}
```

## ç¤ºä¾‹æ’ä»¶

### åŸºç¡€æ’ä»¶æ¨¡æ¿

```typescript
export function setupPlugin({ config }) {
  // æ’ä»¶åˆå§‹åŒ–ä»£ç 
}

export function teardownPlugin() {
  // æ¸…ç†ä»£ç 
}

export async function onEvent(event) {
  // äº‹ä»¶å¤„ç†é€»è¾‘
}
```

### å®šæ—¶ä»»åŠ¡ç¤ºä¾‹

```typescript
export const jobs = {
  dailyReport: {
    name: 'daily-report',
    type: 'schedule',
    exec: async () => {
      // å®šæ—¶ä»»åŠ¡é€»è¾‘
    }
  }
}
```

## æ›´å¤šèµ„æº

- [æ’ä»¶å¼€å‘æ•™ç¨‹](https://posthog.com/docs/plugins/build)
- [API æ–‡æ¡£](https://posthog.com/docs/api)
- [ç¤ºä¾‹æ’ä»¶](https://github.com/PostHog/plugin-examples)
- [æ’ä»¶æœ€ä½³å®è·µ](https://posthog.com/docs/plugins/best-practices)
- [æ•…éšœæ’é™¤æŒ‡å—](https://posthog.com/docs/plugins/troubleshooting)

## æŠ€æœ¯å®ç°

### æ’ä»¶åŠ è½½æµç¨‹

1. æ’ä»¶æ–‡ä»¶è¯»å–
```typescript
function readFileIfExists(baseDir: string, plugin: Plugin, file: string): string | null {
    const fullPath = path.resolve(baseDir, plugin.url!.substring(5), file)
    if (fs.existsSync(fullPath)) {
        return fs.readFileSync(fullPath).toString()
    }
    return null
}
```

2. æ’ä»¶åˆå§‹åŒ–
```typescript
async function loadPlugin(hub: Hub, pluginConfig: PluginConfig): Promise<boolean> {
    // 1. æ£€æŸ¥æ’ä»¶ç±»å‹
    if (plugin.plugin_type === 'inline') {
        await pluginConfig.instance?.initialize!('', pluginDigest(plugin))
        return true
    }

    // 2. åŠ è½½é…ç½®
    const configJson = isLocalPlugin
        ? readFileIfExists(hub.BASE_DIR, plugin, 'plugin.json')
        : plugin.source__plugin_json

    // 3. åŠ è½½æºä»£ç 
    const pluginSource = isLocalPlugin
        ? config['main']
            ? readFileIfExists(hub.BASE_DIR, plugin, config['main'])
            : readFileIfExists(hub.BASE_DIR, plugin, 'index.js')
        : plugin.source__index_ts
}
```

### è™šæ‹Ÿæœºå®ç°

PostHog ä½¿ç”¨ VM2 æ¥è¿è¡Œæ’ä»¶ä»£ç ,ç¡®ä¿å®‰å…¨æ€§å’Œéš”ç¦»æ€§:

```typescript
export class LazyPluginVM implements PluginInstance {
    // æ’ä»¶VMå®ä¾‹
    private vm: VM
    
    // æ’ä»¶çŠ¶æ€
    private ready: boolean
    private inErroredState: boolean
    
    // é‡è¯•æœºåˆ¶
    private totalInitAttemptsCounter: number
    private initRetryTimeout: NodeJS.Timeout | null

    // åˆå§‹åŒ–VM
    private initVm() {
        this.resolveInternalVm = new Promise((resolve) => {
            // VMåˆå§‹åŒ–é€»è¾‘
        })
    }

    // è®¾ç½®æ’ä»¶
    public async setupPluginIfNeeded(): Promise<boolean> {
        if (!this.ready) {
            const vm = (await this.resolveInternalVm)?.vm
            try {
                await this._setupPlugin(vm)
            } catch (error) {
                return false
            }
        }
        return true
    }
}
```

### æ’ä»¶èƒ½åŠ›æ£€æµ‹

```typescript
async function updatePluginCapabilitiesIfNeeded(vm: PluginConfigVMResponse): Promise<void> {
    const capabilities = getVMPluginCapabilities(vm)
    if (!equal(capabilities, this.pluginConfig.plugin?.capabilities)) {
        await setPluginCapabilities(this.hub, this.pluginConfig.plugin!.id, capabilities)
        this.pluginConfig.plugin!.capabilities = capabilities
    }
}
```

### é”™è¯¯å¤„ç†

1. åˆå§‹åŒ–é”™è¯¯
```typescript
class SetupPluginError extends Error {
    constructor(message: string) {
        super(message)
        this.name = 'SetupPluginError'
    }
}
```

2. é”™è¯¯é‡è¯•æœºåˆ¶
```typescript
const VM_INIT_MAX_RETRIES = 5
const INITIALIZATION_RETRY_MULTIPLIER = 2
const INITIALIZATION_RETRY_BASE_MS = 5000
```

### æ€§èƒ½ç›‘æ§

ä½¿ç”¨ Prometheus æŒ‡æ ‡æ”¶é›†æ’ä»¶æ€§èƒ½æ•°æ®:

```typescript
const pluginSetupMsSummary = new Summary({
    name: 'plugin_setup_ms',
    help: 'Time to setup plugins',
    labelNames: ['plugin_id', 'status'],
})

const pluginDisabledBySystemCounter = new Counter({
    name: 'plugin_disabled_by_system',
    help: 'Count of plugins disabled by the system',
    labelNames: ['plugin_id'],
})
```

### æ—¥å¿—ç³»ç»Ÿ

```typescript
async function createLogEntry(
    message: string, 
    logType = PluginLogEntryType.Info
): Promise<void> {
    await this.hub.db.queuePluginLogEntry({
        pluginConfig: this.pluginConfig,
        message: message,
        source: PluginLogEntrySource.System,
        type: logType,
        instanceId: this.hub.instanceId,
    })
}
```

### å®‰å…¨é™åˆ¶

1. è‡ªæˆ‘å¤åˆ¶ä¿æŠ¤
```typescript
if (this.pluginConfig.plugin?.name == 'Replicator') {
    // é˜²æ­¢æ’ä»¶è‡ªæˆ‘å¤åˆ¶å¯¼è‡´æ— é™å¾ªç¯
    const isAllowed = team?.uuid == ALLOWED_UUID && host == ALLOWED_HOST
    if (!isAllowed && team?.api_token.trim() == apiKey.trim()) {
        throw Error('Self replication is not allowed')
    }
}
```

2. èµ„æºé™åˆ¶
```typescript
const RESOURCE_LIMITS = {
    maxMemory: 100 * 1024 * 1024, // 100MB
    timeout: 1000 * 60, // 1åˆ†é’Ÿ
}
```

### æ’ä»¶é€šä¿¡

1. äº‹ä»¶æ€»çº¿
```typescript
interface EventBus {
    emit(event: string, payload: any): void
    on(event: string, handler: (payload: any) => void): void
}
```

2. æ’ä»¶é—´é€šä¿¡
```typescript
async function sendToPlugin(targetPlugin: string, message: any) {
    await this.hub.pluginBus.emit(`plugin:${targetPlugin}`, message)
}
```

## äº‹ä»¶å¤„ç†è¯¦è§£

### äº‹ä»¶ç±»å‹

PostHog æ’ä»¶ç³»ç»Ÿæ”¯æŒä»¥ä¸‹å‡ ç§ä¸»è¦äº‹ä»¶ç±»å‹ï¼š

1. åŸå§‹äº‹ä»¶ (PluginEvent)
```typescript
interface PluginEvent {
    uuid: string           // äº‹ä»¶å”¯ä¸€æ ‡è¯†
    event: string         // äº‹ä»¶åç§°
    properties: Properties // äº‹ä»¶å±æ€§
    timestamp: string     // äº‹ä»¶æ—¶é—´æˆ³
    team_id: number      // å›¢é˜ŸID
    distinct_id: string   // ç”¨æˆ·å”¯ä¸€æ ‡è¯†
}
```

2. å¤„ç†åäº‹ä»¶ (ProcessedPluginEvent)
```typescript
interface ProcessedPluginEvent extends PluginEvent {
    // åŒ…å«äº†æ›´å¤šå¤„ç†åçš„ä¿¡æ¯
    person?: {
        uuid: string
        properties: Properties
        created_at: string
    }
    group_properties?: Record<string, Properties>
}
```

3. PostHog äº‹ä»¶ (PostHogEvent)
```typescript
interface PostHogEvent {
    // ç”¨äºæ–°ç‰ˆæœ¬æ’ä»¶çš„äº‹ä»¶æ ¼å¼
    distinctId: string
    properties: Properties
    event: string
    timestamp: string
    teamId: number
}
```

### äº‹ä»¶å¤„ç†æµç¨‹

1. äº‹ä»¶æ¥æ”¶é˜¶æ®µ
```typescript
// 1. äº‹ä»¶è¿›å…¥ç³»ç»Ÿ
interface PreIngestionEvent {
    eventUuid: string
    event: string
    teamId: number
    projectId: number
    distinctId: string
    properties: Properties
    timestamp: string
}
```

2. äº‹ä»¶å¤„ç†é˜¶æ®µ
```typescript
// 2. æ’ä»¶å¤„ç†äº‹ä»¶
async function processEvent(event: PluginEvent): Promise<PluginEvent> {
    // æ’ä»¶å¯ä»¥:
    // - ä¿®æ”¹äº‹ä»¶å±æ€§
    // - æ·»åŠ æ–°å±æ€§
    // - è¿‡æ»¤äº‹ä»¶
    return event
}

// 3. äº‹ä»¶åå¤„ç†
async function onEvent(event: ProcessedPluginEvent): Promise<void> {
    // æ’ä»¶å¯ä»¥:
    // - å‘é€äº‹ä»¶åˆ°å¤–éƒ¨ç³»ç»Ÿ
    // - è§¦å‘å…¶ä»–æ“ä½œ
    // - è®°å½•æ•°æ®
}
```

3. Webhook å¤„ç†
```typescript
// 4. Webhook ç»„è£…
function composeWebhook(event: PostHogEvent): Webhook | null {
    return {
        url: string,
        headers?: Record<string, string>,
        payload: any
    }
}
```

### ç‰¹æ®Šäº‹ä»¶

1. ç³»ç»Ÿäº‹ä»¶
```typescript
const SYSTEM_EVENTS = {
    $set: 'è®¾ç½®ç”¨æˆ·å±æ€§',
    $identify: 'è¯†åˆ«ç”¨æˆ·',
    $create_alias: 'åˆ›å»ºåˆ«å',
    $merge_dangerously: 'åˆå¹¶ç”¨æˆ·',
    $groupidentify: 'è¯†åˆ«ç»„'
}
```

2. ç›‘æ§äº‹ä»¶
```typescript
interface PluginLogEntry {
    id: string
    team_id: number
    plugin_id: number
    timestamp: string
    source: PluginLogEntrySource
    type: PluginLogEntryType
    message: string
    instance_id: string
}
```

### äº‹ä»¶å±æ€§å¤„ç†

1. å±æ€§ç±»å‹
```typescript
enum PropertyType {
    DateTime = 'DateTime',
    String = 'String',
    Numeric = 'Numeric',
    Boolean = 'Boolean',
    Duration = 'Duration',
    Selector = 'Selector',
    Cohort = 'Cohort'
}
```

2. å±æ€§å®šä¹‰
```typescript
interface PropertyDefinition {
    name: string
    type: PropertyType
    required?: boolean
    default?: any
    description?: string
}
```

### äº‹ä»¶å¤„ç†èƒ½åŠ›

æ’ä»¶æœåŠ¡å™¨æ ¹æ®ä¸åŒæ¨¡å¼æä¾›ä¸åŒçš„äº‹ä»¶å¤„ç†èƒ½åŠ›ï¼š

```typescript
enum PluginServerMode {
    ingestion = 'ingestion',           // äº‹ä»¶æ¥æ”¶
    async_onevent = 'async-onevent',   // å¼‚æ­¥äº‹ä»¶å¤„ç†
    async_webhooks = 'async-webhooks', // å¼‚æ­¥Webhookå¤„ç†
    jobs = 'jobs',                     // ä»»åŠ¡å¤„ç†
    scheduler = 'scheduler'            // è°ƒåº¦å™¨
}
```

### äº‹ä»¶å¤„ç†æŒ‡æ ‡

ç³»ç»Ÿä¼šæ”¶é›†ä»¥ä¸‹äº‹ä»¶å¤„ç†æŒ‡æ ‡ï¼š

1. æ€§èƒ½æŒ‡æ ‡
```typescript
const pluginSetupMsSummary = new Summary({
    name: 'plugin_setup_ms',
    help: 'æ’ä»¶è®¾ç½®æ—¶é—´',
    labelNames: ['plugin_id', 'status']
})
```

2. é”™è¯¯æŒ‡æ ‡
```typescript
const pluginDisabledBySystemCounter = new Counter({
    name: 'plugin_disabled_by_system',
    help: 'ç³»ç»Ÿç¦ç”¨çš„æ’ä»¶æ•°é‡',
    labelNames: ['plugin_id']
})
```

### äº‹ä»¶å¤„ç†æœ€ä½³å®è·µ

1. æ€§èƒ½ä¼˜åŒ–
   - ä½¿ç”¨æ‰¹é‡å¤„ç†
   - å®ç°ç¼“å­˜æœºåˆ¶
   - é¿å…åŒæ­¥é˜»å¡

2. é”™è¯¯å¤„ç†
   - å®ç°é‡è¯•æœºåˆ¶
   - è®°å½•è¯¦ç»†æ—¥å¿—
   - è®¾ç½®è¶…æ—¶é™åˆ¶

3. æ•°æ®éªŒè¯
   - éªŒè¯äº‹ä»¶æ ¼å¼
   - æ£€æŸ¥å¿…è¦å­—æ®µ
   - æ¸…ç†æ— æ•ˆæ•°æ®

4. å®‰å…¨è€ƒè™‘
   - éªŒè¯æ•°æ®æ¥æº
   - é™åˆ¶èµ„æºä½¿ç”¨
   - åŠ å¯†æ•æ„Ÿä¿¡æ¯

## æ’ä»¶æœåŠ¡å™¨å®ç°

### æœåŠ¡å™¨æ¶æ„

1. ä¸»çº¿ç¨‹
```typescript
// ä¸»çº¿ç¨‹è´Ÿè´£:
1. pubSub - åŸºäºRedisçš„å‘å¸ƒè®¢é˜…æœºåˆ¶,ç”¨äºåœ¨ä¸»PostHogåº”ç”¨å‘å¸ƒæ¶ˆæ¯æ—¶é‡æ–°åŠ è½½æ’ä»¶
2. hub - ç®¡ç†æ•°æ®åº“å’Œé˜Ÿåˆ—è¿æ¥(ClickHouse, Kafka, Postgres, Redis)
3. piscina - çº¿ç¨‹æ± ç®¡ç†å™¨
```

2. å·¥ä½œçº¿ç¨‹
```typescript
// æ¯ä¸ªå·¥ä½œçº¿ç¨‹è¿è¡Œ:
1. TASKS_PER_WORKER ä¸ªä»»åŠ¡
2. ç‹¬ç«‹çš„Hubå®ä¾‹
3. ç‹¬ç«‹çš„VMç¯å¢ƒ
```

### æœåŠ¡å™¨æ¨¡å¼

```typescript
enum PluginServerMode {
    all_v2 = 'all-v2',               // å®Œæ•´åŠŸèƒ½
    ingestion = 'ingestion',         // æ•°æ®æ¥æ”¶
    async_onevent = 'async-onevent', // å¼‚æ­¥äº‹ä»¶å¤„ç†
    async_webhooks = 'async-webhooks',// å¼‚æ­¥Webhook
    jobs = 'jobs',                   // ä»»åŠ¡å¤„ç†
    scheduler = 'scheduler',         // è°ƒåº¦å™¨
    analytics_ingestion = 'analytics-ingestion' // åˆ†ææ•°æ®æ¥æ”¶
}
```

### æ’ä»¶åŠ è½½æµç¨‹

1. åˆå§‹åŒ–é˜¶æ®µ
```typescript
async function startPluginsServer(
    config: Partial<PluginsServerConfig>,
    capabilities?: PluginServerCapabilities
): Promise<ServerInstance> {
    // 1. åˆ›å»ºæœåŠ¡å™¨å®ä¾‹
    // 2. åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
    // 3. å¯åŠ¨å·¥ä½œçº¿ç¨‹
    // 4. åŠ è½½æ’ä»¶
}
```

2. æ’ä»¶åŠ è½½
```typescript
async function loadPlugin(hub: Hub, pluginConfig: PluginConfig): Promise<boolean> {
    // 1. æ£€æŸ¥æ’ä»¶ç±»å‹
    if (plugin.plugin_type === 'inline') {
        return initializeInlinePlugin()
    }

    // 2. åŠ è½½é…ç½®
    const configJson = loadPluginConfig()
    
    // 3. åŠ è½½æºä»£ç 
    const pluginSource = loadPluginSource()
    
    // 4. åˆå§‹åŒ–VM
    const vm = createPluginConfigVM()
}
```

3. VMåˆå§‹åŒ–
```typescript
class LazyPluginVM implements PluginInstance {
    private initVm() {
        this.resolveInternalVm = new Promise((resolve) => {
            // 1. åˆ›å»ºVMå®ä¾‹
            const vm = createPluginConfigVM()
            
            // 2. æ£€æµ‹æ’ä»¶èƒ½åŠ›
            await this.updatePluginCapabilitiesIfNeeded(vm)
            
            // 3. è®¾ç½®æ’ä»¶
            if (shouldSetupNow) {
                await this._setupPlugin(vm.vm)
            }
        })
    }
}
```

### æ’ä»¶æ‰§è¡Œç¯å¢ƒ

1. VMé…ç½®
```typescript
function createPluginConfigVM(
    hub: Hub,
    pluginConfig: PluginConfig,
    indexJs: string
): PluginConfigVMResponse {
    // 1. åˆ›å»ºéš”ç¦»çš„VMç¯å¢ƒ
    const vm = new VM({
        sandbox: {
            // æ³¨å…¥å…¨å±€å¯¹è±¡
            console,
            exports,
            require: createRequire()
        }
    })

    // 2. æ³¨å…¥æ’ä»¶API
    const methods = {
        setupPlugin: bindMeta('setupPlugin'),
        teardownPlugin: bindMeta('teardownPlugin'),
        onEvent: bindMeta('onEvent'),
        processEvent: bindMeta('processEvent'),
        composeWebhook: bindMeta('composeWebhook')
    }

    // 3. æ³¨å…¥ä»»åŠ¡API
    const tasks = {
        schedule: {},
        job: {}
    }
}
```

2. å®‰å…¨é™åˆ¶
```typescript
const VM_SECURITY_SETTINGS = {
    timeout: 1000 * 60,          // 60ç§’è¶…æ—¶
    allowAsync: true,            // å…è®¸å¼‚æ­¥
    sandbox: true,               // æ²™ç®±ç¯å¢ƒ
    eval: false,                 // ç¦æ­¢eval
    wasm: false,                // ç¦æ­¢WebAssembly
    fixAsync: true              // ä¿®å¤å¼‚æ­¥é—®é¢˜
}
```

### æ’ä»¶é€šä¿¡æœºåˆ¶

1. Redis PubSub
```typescript
class PubSub {
    // å‘å¸ƒæ¶ˆæ¯
    async publish(channel: string, message: any): Promise<void>
    
    // è®¢é˜…æ¶ˆæ¯
    async subscribe(channel: string, handler: (message: any) => void): Promise<void>
}
```

2. äº‹ä»¶æ€»çº¿
```typescript
class EventBus {
    // å‘é€äº‹ä»¶
    async emit(event: string, payload: any): Promise<void>
    
    // ç›‘å¬äº‹ä»¶
    async on(event: string, handler: (payload: any) => void): Promise<void>
}
```

### é”™è¯¯å¤„ç†æœºåˆ¶

1. é‡è¯•æœºåˆ¶
```typescript
const RETRY_SCHEDULE = {
    maxRetries: 5,
    baseDelay: 5000,
    maxDelay: 60000,
    factor: 2
}
```

2. é”™è¯¯ç›‘æ§
```typescript
interface PluginError {
    message: string
    time: string
    name?: string
    stack?: string
    event?: PluginEvent | null
}
```

### æ€§èƒ½ä¼˜åŒ–

1. æ‰¹å¤„ç†
```typescript
interface BatchProcessor {
    // æ‰¹é‡å¤„ç†äº‹ä»¶
    processBatch(events: PluginEvent[]): Promise<void>
    
    // åˆ·æ–°æ‰¹å¤„ç†
    flush(): Promise<void>
}
```

2. ç¼“å­˜æœºåˆ¶
```typescript
interface CacheManager {
    // è·å–ç¼“å­˜
    get(key: string): Promise<any>
    
    // è®¾ç½®ç¼“å­˜
    set(key: string, value: any, ttl?: number): Promise<void>
}
``` 